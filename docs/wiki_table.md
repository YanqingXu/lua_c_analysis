# ğŸ“Š Lua 5.1.5 è¡¨å®ç°æœºåˆ¶æ·±åº¦è§£æ (ltable.c)

> **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡Luaè¡¨çš„æ··åˆæ•°æ®ç»“æ„è®¾è®¡ï¼Œç†è§£æ•°ç»„+å“ˆå¸Œçš„ä¼˜åŒ–ç­–ç•¥ï¼Œæ·±å…¥åˆ†æåŠ¨æ€æ‰©å®¹ç®—æ³•å’Œæ€§èƒ½ç‰¹å¾ã€‚

## ğŸ¯ æ¨¡å—æ¦‚è¿°

Lua çš„è¡¨ (Table) æ˜¯æ•´ä¸ªè¯­è¨€ä¸­**æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„**ï¼Œå®ƒå·§å¦™åœ°å°†æ•°ç»„å’Œå“ˆå¸Œè¡¨çš„ä¼˜ç‚¹ç»“åˆåœ¨ä¸€èµ·ï¼Œå®ç°äº†ä¸€ç§**æ··åˆå¼æ•°æ®ç»“æ„**ã€‚è¿™ç§è®¾è®¡ä½¿å¾—è¡¨æ—¢èƒ½æä¾›æ•°ç»„çš„é«˜æ•ˆé¡ºåºè®¿é—®ï¼Œåˆèƒ½æ”¯æŒå“ˆå¸Œè¡¨çš„çµæ´»é”®å€¼æ˜ å°„ã€‚

### ğŸ—ï¸ æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **æ··åˆæ¶æ„**ï¼šæ•°ç»„éƒ¨åˆ†å¤„ç†æ•´æ•°ç´¢å¼•ï¼Œå“ˆå¸Œéƒ¨åˆ†å¤„ç†ä»»æ„é”®å€¼
2. **åŠ¨æ€ä¼˜åŒ–**ï¼šæ ¹æ®ä½¿ç”¨æ¨¡å¼è‡ªåŠ¨è°ƒæ•´æ•°ç»„å’Œå“ˆå¸Œçš„å¤§å°æ¯”ä¾‹
3. **å†…å­˜æ•ˆç‡**ï¼šæœ€å°åŒ–å†…å­˜å ç”¨ï¼Œæœ€å¤§åŒ–è®¿é—®æ€§èƒ½
4. **ç¼“å­˜å‹å¥½**ï¼šæ•°æ®å¸ƒå±€ä¼˜åŒ–ï¼Œæé«˜CPUç¼“å­˜å‘½ä¸­ç‡

### ğŸ“Š è¡¨çš„æ··åˆæ¶æ„å¯è§†åŒ–

```mermaid
graph TB
    subgraph "Lua Table æ··åˆæ¶æ„"
        T[Table ç»“æ„ä½“]
        
        subgraph "æ•°ç»„éƒ¨åˆ† Array Part"
            A1["[1] = value1"]
            A2["[2] = value2"]
            A3["[3] = value3"]
            A4["[4] = nil"]
            A5["[5] = value5"]
        end
        
        subgraph "å“ˆå¸Œéƒ¨åˆ† Hash Part"
            H1["['name'] = 'Lua'"]
            H2["[100] = 'big_index'"]
            H3["[true] = 'boolean'"]
            H4["[obj] = 'userdata'"]
        end
        
        T -->|sizearray=5<br/>è¿ç»­å†…å­˜| A1
        T -->|lsizenode=log2 4<br/>æ•£åˆ—å­˜å‚¨| H1
    end
    
    style T fill:#e1f5ff,stroke:#01579b
    style A1 fill:#c8e6c9,stroke:#388e3c
    style A2 fill:#c8e6c9,stroke:#388e3c
    style A3 fill:#c8e6c9,stroke:#388e3c
    style A5 fill:#c8e6c9,stroke:#388e3c
    style H1 fill:#fff3e0,stroke:#e65100
    style H2 fill:#fff3e0,stroke:#e65100
    style H3 fill:#fff3e0,stroke:#e65100
    style H4 fill:#fff3e0,stroke:#e65100
```

### ğŸ¯ é”®å€¼åˆ†é…ç­–ç•¥

```mermaid
flowchart TD
    A[æ’å…¥é”®å€¼å¯¹] --> B{é”®çš„ç±»å‹?}
    B -->|æ­£æ•´æ•°<br/>1,2,3,...| C{åœ¨æ•°ç»„<br/>èŒƒå›´å†…?}
    B -->|å…¶ä»–ç±»å‹<br/>string/bool/...| E[å“ˆå¸Œéƒ¨åˆ†]
    B -->|å¤§æ•´æ•°<br/>100, 1000,...| E
    
    C -->|æ˜¯| D[æ•°ç»„éƒ¨åˆ†<br/>O 1 è®¿é—®]
    C -->|å¦| E[å“ˆå¸Œéƒ¨åˆ†<br/>O 1 å¹³å‡]
    
    D --> F[é«˜æ•ˆè¿ç»­å­˜å‚¨]
    E --> G[çµæ´»é”®å€¼æ˜ å°„]
    
    style A fill:#e1f5ff,stroke:#01579b
    style D fill:#c8e6c9,stroke:#388e3c
    style E fill:#fff3e0,stroke:#e65100
    style F fill:#a5d6a7,stroke:#2e7d32
    style G fill:#ffe0b2,stroke:#f57c00
```

**ğŸ“– å®é™…ç¤ºä¾‹**:
```lua
-- åˆ›å»ºæ··åˆè¡¨
local t = {
    -- æ•°ç»„éƒ¨åˆ†ï¼šæ­£æ•´æ•°ç´¢å¼• [1, 2, 3, 4, 5]
    "apple",      -- t[1]
    "banana",     -- t[2]
    "cherry",     -- t[3]
    nil,          -- t[4] (ç©ºæ´)
    "elderberry", -- t[5]
    
    -- å“ˆå¸Œéƒ¨åˆ†ï¼šéæ•´æ•°é”®
    name = "fruit_basket",  -- å­—ç¬¦ä¸²é”®
    [100] = "large_index",  -- å¤§æ•´æ•°
    [true] = "boolean_key", -- å¸ƒå°”é”®
}

-- å†…å­˜å¸ƒå±€ï¼š
-- array[5]:   ["apple", "banana", "cherry", nil, "elderberry"]
-- hash[?]:    {"name"="fruit_basket", 100="large_index", true="boolean_key"}
```

### ğŸ“‹ Table æ•°æ®ç»“æ„è¯¦è§£

```c
typedef struct Table {
    CommonHeader;              // GCå¯¹è±¡é€šç”¨å¤´éƒ¨ (marked, tt, next)
    lu_byte flags;             // å…ƒæ–¹æ³•ç¼“å­˜æ ‡å¿—ä½ (8ä½ï¼Œæ¯ä½å¯¹åº”ä¸€ä¸ªå…ƒæ–¹æ³•)
    lu_byte lsizenode;         // å“ˆå¸Œéƒ¨åˆ†å¤§å°çš„log2å€¼ (å®é™…å¤§å° = 2^lsizenode)
    struct Table *metatable;   // å…ƒè¡¨æŒ‡é’ˆ
    TValue *array;             // æ•°ç»„éƒ¨åˆ†æŒ‡é’ˆ (è¿ç»­å†…å­˜å—)
    Node *node;                // å“ˆå¸Œéƒ¨åˆ†æŒ‡é’ˆ (Nodeæ•°ç»„)
    Node *lastfree;            // æœ€åä¸€ä¸ªç©ºé—²å“ˆå¸ŒèŠ‚ç‚¹ (ç”¨äºå¿«é€Ÿåˆ†é…)
    GCObject *gclist;          // GCé“¾è¡¨æŒ‡é’ˆ
    int sizearray;             // æ•°ç»„éƒ¨åˆ†å¤§å° (å®é™…å…ƒç´ æ•°é‡)
} Table;
```

**ğŸ” å…³é”®å­—æ®µè§£æ**ï¼š

| å­—æ®µ | ç±»å‹ | ç”¨é€” | ç‰¹ç‚¹ |
|------|------|------|------|
| **flags** | `lu_byte` | å…ƒæ–¹æ³•ç¼“å­˜ | ä½i=1è¡¨ç¤ºå…ƒæ–¹æ³•iä¸å­˜åœ¨ |
| **lsizenode** | `lu_byte` | å“ˆå¸Œå¤§å°log | å®é™…å¤§å°=2^lsizenodeï¼ŒèŒƒå›´0-30 |
| **array** | `TValue*` | æ•°ç»„å­˜å‚¨ | è¿ç»­å†…å­˜ï¼Œæ­£æ•´æ•°ç´¢å¼•[1..n] |
| **node** | `Node*` | å“ˆå¸Œå­˜å‚¨ | å¼€æ”¾å¯»å€ï¼Œå¤„ç†å†²çªç”¨é“¾è¡¨ |
| **lastfree** | `Node*` | ç©ºé—²èŠ‚ç‚¹æŒ‡é’ˆ | ä»åå‘å‰åˆ†é…ï¼ŒåŠ é€Ÿæ’å…¥ |
| **sizearray** | `int` | æ•°ç»„å®¹é‡ | å¿…é¡»æ˜¯2çš„å¹‚æ¬¡(0,1,2,4,8...) |

**ğŸ“ Table å†…å­˜å¸ƒå±€å¯è§†åŒ–**:

```mermaid
graph TB
    subgraph "Table ç»“æ„ä½“ 32å­—èŠ‚ "
        T1["CommonHeader 3å­—èŠ‚"]
        T2["flags 1å­—èŠ‚"]
        T3["lsizenode 1å­—èŠ‚"]
        T4["metatable 8å­—èŠ‚æŒ‡é’ˆ"]
        T5["array 8å­—èŠ‚æŒ‡é’ˆ"]
        T6["node 8å­—èŠ‚æŒ‡é’ˆ"]
        T7["lastfree 8å­—èŠ‚æŒ‡é’ˆ"]
        T8["gclist 8å­—èŠ‚æŒ‡é’ˆ"]
        T9["sizearray 4å­—èŠ‚"]
    end
    
    subgraph "æ•°ç»„éƒ¨åˆ† sizearray*16å­—èŠ‚ "
        A1["TValue[0] 16å­—èŠ‚"]
        A2["TValue[1] 16å­—èŠ‚"]
        A3["TValue[2] 16å­—èŠ‚"]
        A4["..."]
    end
    
    subgraph "å“ˆå¸Œéƒ¨åˆ† 2^lsizenode*32å­—èŠ‚ "
        N1["Node[0] 32å­—èŠ‚"]
        N2["Node[1] 32å­—èŠ‚"]
        N3["Node[2] 32å­—èŠ‚"]
        N4["..."]
    end
    
    T5 -->|æŒ‡å‘| A1
    T6 -->|æŒ‡å‘| N1
    T7 -->|æŒ‡å‘| N4
    
    style T1 fill:#e1f5ff,stroke:#01579b
    style A1 fill:#c8e6c9,stroke:#388e3c
    style N1 fill:#fff3e0,stroke:#e65100
```

### ğŸ”— Node ç»“æ„ (å“ˆå¸Œè¡¨èŠ‚ç‚¹)

```c
typedef struct Node {
  TValue i_val;           // å­˜å‚¨çš„å€¼ (16å­—èŠ‚)
  TKey i_key;             // é”®ä¿¡æ¯ (16å­—èŠ‚)
} Node;  // æ€»å¤§å°ï¼š32å­—èŠ‚

typedef union TKey {
  struct {
    TValuefields;         // é”®çš„å€¼å’Œç±»å‹ (12å­—èŠ‚ï¼šValue+GCObject*+tt)
    struct Node *next;    // å†²çªé“¾è¡¨æŒ‡é’ˆ (4å­—èŠ‚ï¼Œç”¨äºå¼€æ”¾å¯»å€)
  } nk;
  TValue tvk;             // ä½œä¸º TValue è®¿é—® (16å­—èŠ‚å¯¹é½)
} TKey;
```

**ğŸ”„ Node å†²çªé“¾è¡¨å¯è§†åŒ–**:

```mermaid
flowchart LR
    subgraph "Hash Table"
        direction TB
        N0["Node[0]<br/>key='name'<br/>val='Lua'<br/>next=NULL"]
        N1["Node[1]<br/>key='version'<br/>val='5.1'<br/>next=â†’N3"]
        N2["Node[2]<br/>key='author'<br/>val='Roberto'<br/>next=NULL"]
        N3["Node[3]<br/>key='year'<br/>val='2006'<br/>next=NULL"]
    end
    
    N1 -.å†²çªé“¾.-> N3
    
    style N0 fill:#c8e6c9,stroke:#388e3c
    style N1 fill:#fff3e0,stroke:#e65100
    style N2 fill:#c8e6c9,stroke:#388e3c
    style N3 fill:#ffcdd2,stroke:#c62828
```

**ğŸ“ è¯´æ˜**:
- **å†²çªå¤„ç†**: Node[1]çš„ä¸»ä½ç½®è¢«å ç”¨ï¼Œé€šè¿‡nextæŒ‡é’ˆé“¾æ¥åˆ°Node[3]
- **Brentå˜ç§**: ä¼˜åŒ–å†²çªèŠ‚ç‚¹ä½ç½®ï¼Œå‡å°‘æŸ¥æ‰¾è·³æ•°
- **lastfree**: ä»æ•°ç»„æœ«å°¾å‘å‰åˆ†é…ç©ºé—²èŠ‚ç‚¹

### ğŸ­ å…ƒæ–¹æ³•ç¼“å­˜æœºåˆ¶ (flagså­—æ®µ)

**flagsä½æ ‡å¿—è¯¦è§£**:

| ä½ | å…ƒæ–¹æ³• | flags=1æ—¶ | ç”¨é€” |
|----|----|--------|------|
| 0 | `__index` | ä¸å­˜åœ¨ | è¡¨ç´¢å¼• |
| 1 | `__newindex` | ä¸å­˜åœ¨ | è¡¨èµ‹å€¼ |
| 2 | `__gc` | ä¸å­˜åœ¨ | åƒåœ¾å›æ”¶ |
| 3 | `__mode` | ä¸å­˜åœ¨ | å¼±è¡¨æ¨¡å¼ |
| 4 | `__eq` | ä¸å­˜åœ¨ | ç›¸ç­‰æ¯”è¾ƒ |
| 5 | `__add` | ä¸å­˜åœ¨ | åŠ æ³• |
| 6 | `__sub` | ä¸å­˜åœ¨ | å‡æ³• |
| 7 | `__mul` | ä¸å­˜åœ¨ | ä¹˜æ³• |

```c
// flags å­—æ®µç¼“å­˜å…ƒæ–¹æ³•ä¿¡æ¯
#define gfasttm(g,et,e) ((et) == NULL ? NULL : \
  ((et)->flags & (1u<<(e))) ? NULL : luaT_gettm(et, e, (g)->tmname[e]))
```

**ğŸ”„ å…ƒæ–¹æ³•æŸ¥æ‰¾æµç¨‹**:

```mermaid
flowchart TD
    A[è®¿é—® t.key ] --> B{tæœ‰å…ƒè¡¨?}
    B -->|æ— | C[è¿”å›nil]
    B -->|æœ‰| D{flagsä½<br/>æ˜¯å¦ä¸º1?}
    D -->|æ˜¯| E[å…ƒæ–¹æ³•ä¸å­˜åœ¨<br/>è¿”å›NULL]
    D -->|å¦| F[æŸ¥æ‰¾å…ƒè¡¨]
    F --> G{æ‰¾åˆ°<br/>å…ƒæ–¹æ³•?}
    G -->|æ˜¯| H[è°ƒç”¨å…ƒæ–¹æ³•]
    G -->|å¦| I[è®¾ç½®flagsä½=1<br/>æ ‡è®°ä¸å­˜åœ¨]
    I --> C
    
    style A fill:#e1f5ff,stroke:#01579b
    style E fill:#ffcdd2,stroke:#c62828
    style H fill:#c8e6c9,stroke:#388e3c
    style I fill:#fff3e0,stroke:#e65100
```

**ğŸ“– ä½¿ç”¨ç¤ºä¾‹**:
```lua
-- åˆ›å»ºå¸¦å…ƒè¡¨çš„è¡¨
local t = {x = 10}
local mt = {
    __index = function(t, k)
        print("Accessing key:", k)
        return 0
    end
}
setmetatable(t, mt)

-- ç¬¬ä¸€æ¬¡è®¿é—®t.y
local a = t.y  -- æŸ¥æ‰¾å…ƒè¡¨ï¼Œè°ƒç”¨__indexï¼Œflags[__index]=0

-- ç¬¬äºŒæ¬¡è®¿é—®t.z  
local b = t.z  -- ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œä¸å†æŸ¥æ‰¾å…ƒè¡¨

-- å½“tçš„å…ƒè¡¨æ”¹å˜æ—¶
t.flags = 0    -- æ¸…é™¤æ‰€æœ‰ç¼“å­˜æ ‡å¿—ï¼Œå¼ºåˆ¶é‡æ–°æŸ¥æ‰¾
```

## ğŸ’¡ è®¾è®¡åŸç†

### æ··åˆå­˜å‚¨ç­–ç•¥

Lua è¡¨é‡‡ç”¨æ··åˆå­˜å‚¨ç­–ç•¥ï¼Œå°†æ•°æ®åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

1. **æ•°ç»„éƒ¨åˆ†** (`array`):
   - å­˜å‚¨éè´Ÿæ•´æ•°é”®çš„å…ƒç´  `[1, 2, 3, ..., n]`
   - è¿ç»­å­˜å‚¨ï¼Œè®¿é—®æ•ˆç‡é«˜ O(1)
   - å¤§å°ä¸º 2 çš„å¹‚æ¬¡ (1, 2, 4, 8, 16, 32, ...)
   - å ç”¨å†…å­˜: `sizearray * sizeof(TValue)` = `n * 16å­—èŠ‚`

2. **å“ˆå¸Œéƒ¨åˆ†** (`node`):
   - å­˜å‚¨å…¶ä»–ç±»å‹çš„é”® (å­—ç¬¦ä¸²ã€æµ®ç‚¹æ•°ã€å¤§æ•´æ•°ã€å¯¹è±¡)
   - ä½¿ç”¨å¼€æ”¾å¯»å€æ³•å¤„ç†å†²çª
   - é‡‡ç”¨ Brent å˜ç§ç®—æ³•ä¼˜åŒ–æŸ¥æ‰¾è·¯å¾„
   - å ç”¨å†…å­˜: `2^lsizenode * sizeof(Node)` = `2^n * 32å­—èŠ‚`

**ğŸ“Š å­˜å‚¨ç­–ç•¥å¯¹æ¯”**:

```mermaid
graph LR
    subgraph "çº¯æ•°ç»„æ¨¡å¼"
        A1["ä¼˜ç‚¹ï¼š<br/>O 1 è®¿é—®<br/>å†…å­˜è¿ç»­"]
        A2["ç¼ºç‚¹ï¼š<br/>ç¨€ç–æµªè´¹<br/>å¤§ç´¢å¼•ä½æ•ˆ"]
    end
    
    subgraph "çº¯å“ˆå¸Œæ¨¡å¼"
        H1["ä¼˜ç‚¹ï¼š<br/>ä»»æ„é”®<br/>æ— ç©ºé—´æµªè´¹"]
        H2["ç¼ºç‚¹ï¼š<br/>å†…å­˜ç¢ç‰‡<br/>æŒ‡é’ˆå¼€é”€"]
    end
    
    subgraph "æ··åˆæ¨¡å¼ Lua "
        M1["æ•°ç»„éƒ¨åˆ†<br/>å¯†é›†æ•´æ•°"]
        M2["å“ˆå¸Œéƒ¨åˆ†<br/>å…¶ä»–é”®"]
        M1 -.->|åŠ¨æ€å¹³è¡¡| M2
    end
    
    style M1 fill:#c8e6c9,stroke:#388e3c
    style M2 fill:#fff3e0,stroke:#e65100
    style A2 fill:#ffcdd2,stroke:#c62828
    style H2 fill:#ffcdd2,stroke:#c62828
```

### æ•°ç»„å¤§å°çš„ç¡®å®š

**ğŸ¯ æ ¸å¿ƒåŸåˆ™**: æ•°ç»„å¤§å° `n` åº”è¯¥æ˜¯**æœ€å¤§çš„ 2 çš„å¹‚æ¬¡**ï¼Œä½¿å¾—æ•°ç»„ä¸­**è‡³å°‘ä¸€åŠçš„ä½ç½®è¢«ä½¿ç”¨**ã€‚

**æ•°å­¦è¡¨è¾¾**:
```
å¯¹äºæ•°ç»„å¤§å° n = 2^kï¼Œæ»¡è¶³ï¼š
ä½¿ç”¨ç‡ = count(énilå…ƒç´ ) / n >= 50%
```

**ğŸ”„ è®¡ç®—æµç¨‹å¯è§†åŒ–**:

```mermaid
flowchart TD
    A[ç»Ÿè®¡å„åŒºé—´çš„å…ƒç´ æ•°é‡] --> B[nums 0...MAXBITS ]
    B --> C[éå†2çš„å¹‚æ¬¡:<br/>1,2,4,8,16...]
    C --> D{ç´¯è®¡å…ƒç´ æ•°<br/>> å¹‚æ¬¡/2?}
    D -->|æ˜¯| E[è®°å½•å€™é€‰å¤§å°]
    D -->|å¦| F[ç»§ç»­ä¸‹ä¸€ä¸ªå¹‚æ¬¡]
    E --> F
    F --> G{éå†å®Œæˆ?}
    G -->|å¦| C
    G -->|æ˜¯| H[è¿”å›æœ€å¤§å€™é€‰]
    
    style A fill:#e1f5ff,stroke:#01579b
    style D fill:#fff3e0,stroke:#e65100
    style E fill:#c8e6c9,stroke:#388e3c
    style H fill:#a5d6a7,stroke:#2e7d32
```

```c
// æ•°ç»„å¤§å°è®¡ç®—é€»è¾‘
static int computesizes (int nums[], int *narray) {
  int i;
  int twotoi;  // 2^i (å½“å‰æ£€æŸ¥çš„æ•°ç»„å¤§å°)
  int a = 0;   // ç´¯è®¡çš„å…ƒç´ æ•°é‡
  int na = 0;  // æœ€ä¼˜çš„æ•°ç»„å¤§å°
  int n = 0;   // å€™é€‰çš„æ•°ç»„å¤§å°
  
  // éå†æ‰€æœ‰2çš„å¹‚æ¬¡: 1, 2, 4, 8, 16, 32, ...
  for (i = 0, twotoi = 1; twotoi/2 < *narray; i++, twotoi *= 2) {
    if (nums[i] > 0) {
      a += nums[i];              // ç´¯åŠ è¯¥åŒºé—´çš„å…ƒç´ æ•°é‡
      if (a > twotoi/2) {        // å¦‚æœè¶…è¿‡ä¸€åŠè¢«ä½¿ç”¨
        n = twotoi;              // è®°å½•è¿™ä¸ªå¤§å°
        na = a;                  // è®°å½•ä½¿ç”¨çš„å…ƒç´ æ•°
      }
    }
  }
  
  *narray = n;
  lua_assert(na <= *narray && *narray <= 2*na);  // ä½¿ç”¨ç‡åœ¨50%-100%ä¹‹é—´
  return na;
}
```

**ğŸ“– å®é™…ç¤ºä¾‹**:

```lua
-- ç¤ºä¾‹1ï¼šå¯†é›†æ•°ç»„
local t1 = {[1]=1, [2]=2, [3]=3, [4]=4, [5]=5}
-- ç»Ÿè®¡ï¼šnums[0-1]=5 (åŒºé—´[1,2]æœ‰2ä¸ªï¼ŒåŒºé—´[3,4]æœ‰2ä¸ªï¼ŒåŒºé—´[5,8]æœ‰1ä¸ª)
-- è®¡ç®—ï¼š
--   n=2: ä½¿ç”¨2/2=1 âœ“ â†’ å€™é€‰
--   n=4: ä½¿ç”¨4/4=1 âœ“ â†’ å€™é€‰  
--   n=8: ä½¿ç”¨5/8<1 âœ—
-- ç»“æœï¼šsizearray=4 (ä½¿ç”¨ç‡=5/4>50%ï¼Œéœ€è¦8æ‰èƒ½å®¹çº³)
-- å®é™…ï¼šsizearray=8 (å› ä¸º5>4ï¼Œéœ€è¦ä¸‹ä¸€ä¸ªå¹‚æ¬¡)

-- ç¤ºä¾‹2ï¼šç¨€ç–æ•°ç»„
local t2 = {[1]=1, [100]=2}
-- ç»Ÿè®¡ï¼šnums[0-1]=1, nums[64-128]=1
-- è®¡ç®—ï¼š
--   n=1: ä½¿ç”¨1/1=1 âœ“
--   n=2: ä½¿ç”¨1/2<1 âœ—
--   ...
--   n=128: ä½¿ç”¨2/128<1 âœ—
-- ç»“æœï¼šsizearray=1, å…¶ä½™è¿›å“ˆå¸Œéƒ¨åˆ†

-- ç¤ºä¾‹3ï¼šè¿ç»­ä½†æœ‰ç©ºæ´
local t3 = {[1]=1, [2]=2, [3]=nil, [4]=4, [5]=5}
-- ç»Ÿè®¡ï¼šnums[0-1]=2, nums[2-4]=2 (ä¸è®¡nil)
-- è®¡ç®—ï¼š
--   n=2: ä½¿ç”¨2/2=1 âœ“
--   n=4: ä½¿ç”¨4/4=1 âœ“
--   n=8: ä½¿ç”¨4/8<1 âœ—
-- ç»“æœï¼šsizearray=4 (ä½¿ç”¨ç‡=4/4=100%)
```

**âš¡ ä¼˜åŒ–æ•ˆæœ**:

| åœºæ™¯ | æ•°ç»„å¤§å° | ä½¿ç”¨ç‡ | å†…å­˜å¼€é”€ |
|------|----------|--------|----------|
| å¯†é›†æ•°ç»„ [1-100] | 128 | 78% | 2KB (128*16) |
| ç¨€ç–æ•°ç»„ [1,1000] | 1 | 100% | 16B (1*16) + å“ˆå¸Œ |
| å¸¦ç©ºæ´ [1-100é™¤50] | 128 | 77% | 2KB |

## ğŸ” å“ˆå¸Œç®—æ³•

### ä¸»ä½ç½®è®¡ç®—

ä¸åŒç±»å‹çš„é”®ä½¿ç”¨ä¸åŒçš„å“ˆå¸Œå‡½æ•°ï¼Œç¡®ä¿å‡åŒ€åˆ†å¸ƒï¼š

```c
static Node *mainposition (const Table *t, const TValue *key) {
  switch (ttype(key)) {
    case LUA_TNUMBER:
      return hashnum(t, nvalue(key));      // æ•°å­—å“ˆå¸Œ
    case LUA_TSTRING:
      return hashstr(t, rawtsvalue(key));  // å­—ç¬¦ä¸²å“ˆå¸Œ
    case LUA_TBOOLEAN:
      return hashboolean(t, bvalue(key));  // å¸ƒå°”å“ˆå¸Œ
    case LUA_TLIGHTUSERDATA:
      return hashpointer(t, pvalue(key));  // æŒ‡é’ˆå“ˆå¸Œ
    default:
      return hashpointer(t, gcvalue(key)); // GCå¯¹è±¡å“ˆå¸Œ
  }
}
```

**ğŸ”„ ä¸»ä½ç½®è®¡ç®—æµç¨‹**:

```mermaid
flowchart TD
    A[è®¡ç®—é”®çš„å“ˆå¸Œå€¼] --> B{é”®çš„ç±»å‹?}
    B -->|æ•°å­—| C[hashnum<br/>æµ®ç‚¹æ•°æ··åˆ]
    B -->|å­—ç¬¦ä¸²| D[hashstr<br/>ä½¿ç”¨é¢„è®¡ç®—hash]
    B -->|å¸ƒå°”| E[hashboolean<br/>0æˆ–1]
    B -->|æŒ‡é’ˆ| F[hashpointer<br/>åœ°å€æ··åˆ]
    
    C --> G[hash % tablesize]
    D --> G
    E --> G
    F --> G
    
    G --> H[Node mainpos ]
    
    style A fill:#e1f5ff,stroke:#01579b
    style H fill:#c8e6c9,stroke:#388e3c
    style G fill:#fff3e0,stroke:#e65100
```

### æ•°å­—å“ˆå¸Œç®—æ³•

```c
static Node *hashnum (const Table *t, lua_Number n) {
  unsigned int a[numints];  // numints = sizeof(lua_Number)/sizeof(int)
  int i;
  n += 1;  // è§„èŒƒåŒ–æ•°å­—ï¼ˆé¿å… -0 å’Œ +0 çš„å·®å¼‚ï¼‰
  
  // å°†æµ®ç‚¹æ•°çš„å­—èŠ‚è¡¨ç¤ºå¤åˆ¶åˆ°æ•´æ•°æ•°ç»„
  memcpy(a, &n, sizeof(a));
  
  // æ··åˆæ‰€æœ‰æ•´æ•°éƒ¨åˆ†
  for (i = 1; i < numints; i++) 
    a[0] += a[i];
    
  return hashmod(t, a[0]);
}

#define hashmod(t,n) (gnode(t, ((n) % ((sizenode(t)-1)|1))))
```

**ğŸ“– å“ˆå¸Œç¤ºä¾‹**:
```lua
-- æ•°å­—é”®çš„å“ˆå¸Œè®¡ç®—
local t = {}
t[3.14] = "pi"      -- hashnum(3.14) â†’ å°†æµ®ç‚¹æ•°å­—èŠ‚æ··åˆ
t[42] = "answer"    -- hashnum(42.0) â†’ æ•´æ•°ä¹ŸæŒ‰æµ®ç‚¹å¤„ç†
t[-0] = "neg_zero"  -- n+1è§„èŒƒåŒ– â†’ ä¸+0ç›¸åŒ

-- å­—ç¬¦ä¸²é”®çš„å“ˆå¸Œ
t["name"] = "Lua"   -- ä½¿ç”¨å­—ç¬¦ä¸²é¢„è®¡ç®—çš„hashå­—æ®µ
t[""] = "empty"     -- ç©ºå­—ç¬¦ä¸²ä¹Ÿæœ‰hashå€¼

-- å¸ƒå°”é”®çš„å“ˆå¸Œ
t[true] = 1         -- hashboolean(1) â†’ ç®€å•æ˜ å°„
t[false] = 0        -- hashboolean(0)
```

### å†²çªè§£å†³ - Brentå˜ç§ç®—æ³•

Lua ä½¿ç”¨**å¼€æ”¾å¯»å€æ³•**çš„ **Brent å˜ç§**æ¥è§£å†³å“ˆå¸Œå†²çªï¼š

**ğŸ¯ æ ¸å¿ƒæ€æƒ³**:
1. æ–°é”®ä¼˜å…ˆæ”¾åœ¨ä¸»ä½ç½®
2. å¦‚æœä¸»ä½ç½®è¢«å ç”¨ï¼Œæ£€æŸ¥å ç”¨è€…æ˜¯å¦åœ¨å…¶ä¸»ä½ç½®
3. å¦‚æœå ç”¨è€…ä¸åœ¨ä¸»ä½ç½®ï¼Œå°†å…¶ç§»åŠ¨åˆ°ç©ºé—²ä½ç½®
4. æ–°é”®å æ®ä¸»ä½ç½®

**ğŸ”„ Brentç®—æ³•æµç¨‹å¯è§†åŒ–**:

```mermaid
flowchart TD
    A[æ’å…¥æ–°é”® newkey ] --> B[è®¡ç®—ä¸»ä½ç½® mp]
    B --> C{mpè¢«å ç”¨?}
    C -->|å¦| D[ç›´æ¥æ’å…¥mp]
    C -->|æ˜¯| E{mpä¸­çš„é”®<br/>åœ¨ä¸»ä½ç½®?}
    E -->|æ˜¯| F[æŸ¥æ‰¾ç©ºé—²ä½ç½®]
    E -->|å¦| G[å°†mpä¸­çš„æ—§é”®<br/>ç§»åˆ°ç©ºé—²ä½ç½®]
    G --> H[æ–°é”®å æ®mp]
    F --> I{æ‰¾åˆ°ç©ºé—²?}
    I -->|æ˜¯| J[æ–°é”®æ’å…¥ç©ºé—²ä½ç½®<br/>é“¾æ¥åˆ°mp]
    I -->|å¦| K[è§¦å‘rehash<br/>æ‰©å®¹]
    
    style D fill:#c8e6c9,stroke:#388e3c
    style H fill:#c8e6c9,stroke:#388e3c
    style J fill:#fff3e0,stroke:#e65100
    style K fill:#ffcdd2,stroke:#c62828
```

**ğŸ“– å†²çªè§£å†³ç¤ºä¾‹**:

```
åˆå§‹çŠ¶æ€: å“ˆå¸Œè¡¨å¤§å°=4
Node[0]: empty
Node[1]: empty  
Node[2]: empty
Node[3]: empty
lastfree â†’ Node[3]

æ­¥éª¤1: æ’å…¥ key1 (ä¸»ä½ç½®=1)
Node[0]: empty
Node[1]: {key1, val1, next=NULL}  â† ç›´æ¥æ’å…¥
Node[2]: empty
Node[3]: empty

æ­¥éª¤2: æ’å…¥ key2 (ä¸»ä½ç½®=1ï¼Œå†²çª!)
Node[0]: empty
Node[1]: {key1, val1, next=â†’3}
Node[2]: empty
Node[3]: {key2, val2, next=NULL}  â† é“¾æ¥åˆ°Node[1]
lastfree â†’ Node[2]

æ­¥éª¤3: æ’å…¥ key3 (ä¸»ä½ç½®=1ï¼Œå†²çª!)
æ£€æŸ¥ï¼škey1åœ¨ä¸»ä½ç½®? æ˜¯
æ£€æŸ¥ï¼škey2åœ¨ä¸»ä½ç½®? å¦ (ä¸»ä½ç½®=1ï¼Œå®é™…åœ¨3)
æ“ä½œï¼šå°†key2ç§»åˆ°Node[2]ï¼Œkey3å æ®Node[3]

Node[0]: empty
Node[1]: {key1, val1, next=â†’2}
Node[2]: {key2, val2, next=â†’3}  â† key2è¢«ç§»åŠ¨
Node[3]: {key3, val3, next=NULL} â† key3å æ®ä¸»ä½ç½®
```

**âš¡ Brentç®—æ³•ä¼˜åŠ¿**:
- âœ… **å‡å°‘é“¾é•¿** - ä¼˜å…ˆè®©æ–°é”®å æ®ä¸»ä½ç½®
- âœ… **æŸ¥æ‰¾æ›´å¿«** - å¹³å‡é“¾é•¿æ›´çŸ­
- âœ… **ç¼“å­˜å‹å¥½** - å‡å°‘è·³è½¬æ¬¡æ•°

### ç©ºé—²ä½ç½®åˆ†é… (getfreepos)

```c
static Node *getfreepos (Table *t) {
  while (t->lastfree-- > t->node) {
    if (ttisnil(gkey(t->lastfree)))
      return t->lastfree;  // æ‰¾åˆ°ç©ºé—²ä½ç½®
  }
  return NULL;  // æ²¡æœ‰ç©ºé—²ä½ç½®
}
```

**ğŸ”„ lastfreeæŒ‡é’ˆç§»åŠ¨**:

```mermaid
flowchart LR
    N0[Node 0] --> N1[Node 1]
    N1 --> N2[Node 2]
    N2 --> N3[Node 3]
    N3 -.lastfreeåˆå§‹.-> END[æœ«å°¾]
    
    N3 -.ç¬¬1æ¬¡åˆ†é….-> N2
    N2 -.ç¬¬2æ¬¡åˆ†é….-> N1
    N1 -.ç¬¬3æ¬¡åˆ†é….-> N0
    N0 -.ç¬¬4æ¬¡åˆ†é….-> FULL[å·²æ»¡â†’rehash]
    
    style END fill:#c8e6c9,stroke:#388e3c
    style FULL fill:#ffcdd2,stroke:#c62828
```

**ğŸ’¡ è®¾è®¡å·§å¦™ä¹‹å¤„**:
- **ä»åå‘å‰**: é¿å…å¹²æ‰°å·²æœ‰çš„å†²çªé“¾
- **æ‡’æƒ°åˆ†é…**: åªåœ¨éœ€è¦æ—¶æ‰æŸ¥æ‰¾
- **O(1)å‡æ‘Š**: æ¯ä¸ªä½ç½®æœ€å¤šè¢«æ£€æŸ¥ä¸€æ¬¡

## âš™ï¸ å…³é”®æ“ä½œå®ç°

### 1. è·å–æ“ä½œ (luaH_get)

```c
const TValue *luaH_get (Table *t, const TValue *key) {
  switch (ttype(key)) {
    case LUA_TNIL: 
      return luaO_nilobject;  // nilé”®è¿”å›nil
      
    case LUA_TSTRING: 
      return luaH_getstr(t, rawtsvalue(key));  // å­—ç¬¦ä¸²ä¸“ç”¨ä¼˜åŒ–
      
    case LUA_TNUMBER: {
      int k;
      lua_Number n = nvalue(key);
      lua_number2int(k, n);  // å°è¯•è½¬ä¸ºæ•´æ•°
      if (luai_numeq(cast_num(k), nvalue(key)))
        return luaH_getnum(t, k);  // æ•´æ•°é”®ï¼Œå°è¯•æ•°ç»„éƒ¨åˆ†
      // å¦åˆ™è¿›å…¥å“ˆå¸Œéƒ¨åˆ†
    }
    
    default: {
      Node *n = mainposition(t, key);  // è®¡ç®—ä¸»ä½ç½®
      do {  // æ²¿ç€å†²çªé“¾æŸ¥æ‰¾
        if (luaO_rawequalObj(key2tval(n), key))
          return gval(n);  // æ‰¾åˆ°åŒ¹é…çš„é”®
        else n = gnext(n);
      } while (n);
      return luaO_nilobject;  // æœªæ‰¾åˆ°
    }
  }
}
```

**ğŸ”„ luaH_getæ‰§è¡Œæµç¨‹**:

```mermaid
flowchart TD
    A[luaH_get t, key ] --> B{keyç±»å‹?}
    B -->|nil| C[è¿”å›nil]
    B -->|string| D[luaH_getstr<br/>å­—ç¬¦ä¸²ä¼˜åŒ–]
    B -->|number| E{èƒ½è½¬ä¸º<br/>æ•´æ•°?}
    B -->|other| G[hashnum hash<br/>è®¡ç®—ä¸»ä½ç½®]
    
    E -->|æ˜¯| F{åœ¨æ•°ç»„<br/>èŒƒå›´å†…?}
    E -->|å¦| G
    
    F -->|æ˜¯| H[array k <br/>O 1 ]
    F -->|å¦| G
    
    G --> I[éå†å†²çªé“¾]
    I --> J{æ‰¾åˆ°?}
    J -->|æ˜¯| K[è¿”å›value]
    J -->|å¦| C
    
    D --> K
    H --> K
    
    style A fill:#e1f5ff,stroke:#01579b
    style H fill:#c8e6c9,stroke:#388e3c
    style K fill:#a5d6a7,stroke:#2e7d32
    style C fill:#ffcdd2,stroke:#c62828
```

**ğŸ“– ä½¿ç”¨ç¤ºä¾‹**:
```lua
local t = {
    [1] = "a",         -- æ•°ç»„éƒ¨åˆ†
    [2] = "b",         -- æ•°ç»„éƒ¨åˆ†
    ["name"] = "Lua",  -- å“ˆå¸Œéƒ¨åˆ†
    [100] = "big"      -- å“ˆå¸Œéƒ¨åˆ†
}

-- è®¿é—®æ•°ç»„éƒ¨åˆ† - å¿«é€Ÿè·¯å¾„
local v1 = t[1]    -- luaH_getnum(t, 1) â†’ array[0]

-- è®¿é—®å“ˆå¸Œéƒ¨åˆ† - å­—ç¬¦ä¸²ä¼˜åŒ–
local v2 = t["name"]  -- luaH_getstr(t, "name")

-- è®¿é—®å“ˆå¸Œéƒ¨åˆ† - å¤§æ•´æ•°
local v3 = t[100]  -- mainposition â†’ éå†é“¾è¡¨

-- è®¿é—®ä¸å­˜åœ¨çš„é”®
local v4 = t["missing"]  -- è¿”å› nil
```

### 2. è®¾ç½®æ“ä½œ (luaH_set)

```c
TValue *luaH_set (lua_State *L, Table *t, const TValue *key) {
  const TValue *p = luaH_get(t, key);  // å…ˆå°è¯•æŸ¥æ‰¾
  t->flags = 0;  // æ¸…é™¤å…ƒæ–¹æ³•ç¼“å­˜æ ‡å¿—
  
  if (p != luaO_nilobject)
    return cast(TValue *, p);  // é”®å·²å­˜åœ¨ï¼Œè¿”å›valueä½ç½®
  else {
    if (ttisnil(key)) 
      luaG_runerror(L, "table index is nil");  // ä¸å…è®¸nilé”®
    return newkey(L, t, key);  // æ’å…¥æ–°é”®
  }
}
```

**ğŸ”„ luaH_setæ‰§è¡Œæµç¨‹**:

```mermaid
flowchart TD
    A[luaH_set t, key ] --> B[luaH_getæŸ¥æ‰¾]
    B --> C{é”®å­˜åœ¨?}
    C -->|æ˜¯| D[è¿”å›valueåœ°å€<br/>ç›´æ¥ä¿®æ”¹]
    C -->|å¦| E{key==nil?}
    E -->|æ˜¯| F[æŠ¥é”™ï¼š<br/>table index is nil]
    E -->|å¦| G[newkeyæ’å…¥æ–°é”®]
    G --> H{æœ‰ç©ºé—²<br/>ä½ç½®?}
    H -->|æ˜¯| I[åˆ†é…å¹¶æ’å…¥]
    H -->|å¦| J[rehashæ‰©å®¹]
    J --> I
    
    D --> K[æ¸…é™¤flagsç¼“å­˜]
    I --> K
    
    style A fill:#e1f5ff,stroke:#01579b
    style D fill:#c8e6c9,stroke:#388e3c
    style I fill:#fff3e0,stroke:#e65100
    style F fill:#ffcdd2,stroke:#c62828
    style J fill:#ffe0b2,stroke:#f57c00
```

**ğŸ“– ä½¿ç”¨ç¤ºä¾‹**:
```lua
local t = {}

-- æƒ…å†µ1ï¼šæ–°é”®æ’å…¥
t[1] = "a"         -- newkey â†’ æ•°ç»„éƒ¨åˆ†
t["name"] = "Lua"  -- newkey â†’ å“ˆå¸Œéƒ¨åˆ†

-- æƒ…å†µ2ï¼šå·²å­˜åœ¨é”®ï¼Œç›´æ¥ä¿®æ”¹
t[1] = "A"         -- ç›´æ¥ä¿®æ”¹ array[0]
t["name"] = "Lua 5.1"  -- ç›´æ¥ä¿®æ”¹å“ˆå¸ŒèŠ‚ç‚¹

-- æƒ…å†µ3ï¼šé”™è¯¯ - nilé”®
t[nil] = "error"   -- è¿è¡Œæ—¶é”™è¯¯ï¼

-- æƒ…å†µ4ï¼šè§¦å‘rehash
for i = 1, 100 do
    t[i] = i       -- å½“ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨æ‰©å®¹
end
```

### 3. æ’å…¥æ–°é”® (newkey)

```c
static TValue *newkey (lua_State *L, Table *t, const TValue *key) {
  Node *mp = mainposition(t, key);  // è®¡ç®—ä¸»ä½ç½®
  
  if (!ttisnil(gval(mp)) || mp == dummynode) {
    Node *othern;
    Node *n = getfreepos(t);  // è·å–ç©ºé—²ä½ç½®
    
    if (n == NULL) {  // æ²¡æœ‰ç©ºé—²ä½ç½®
      rehash(L, t, key);  // æ‰©å±•è¡¨
      return luaH_set(L, t, key);  // é‡æ–°æ’å…¥
    }
    
    // Brentç®—æ³•ï¼šå¤„ç†å†²çª
    othern = mainposition(t, key2tval(mp));  // å ç”¨è€…çš„ä¸»ä½ç½®
    if (othern != mp) {  // å ç”¨è€…ä¸åœ¨ä¸»ä½ç½®
      // å°†å ç”¨è€…ç§»åˆ°ç©ºé—²ä½ç½®
      while (gnext(othern) != mp) othern = gnext(othern);
      gnext(othern) = n;
      *n = *mp;
      gnext(mp) = NULL;
      setnilvalue(gval(mp));
    }
    else {  // å ç”¨è€…åœ¨ä¸»ä½ç½®ï¼Œæ–°é”®æ”¾åˆ°ç©ºé—²ä½ç½®
      gnext(n) = gnext(mp);
      gnext(mp) = n;
      mp = n;
    }
  }
  
  setobj2t(L, gkey(mp), key);
  luaC_barriert(L, t, key);
  return gval(mp);
}
```

**ğŸ”„ newkeyæ’å…¥ç­–ç•¥å¯è§†åŒ–**:

```mermaid
flowchart TD
    A[æ’å…¥æ–°é”®] --> B[è®¡ç®—ä¸»ä½ç½®mp]
    B --> C{mpè¢«å ç”¨?}
    C -->|å¦| D[ç›´æ¥æ’å…¥mp]
    C -->|æ˜¯| E[è·å–ç©ºé—²ä½ç½®n]
    E --> F{æ‰¾åˆ°ç©ºé—²?}
    F -->|å¦| G[rehashæ‰©å®¹]
    F -->|æ˜¯| H{mpä¸­çš„é”®<br/>åœ¨ä¸»ä½ç½®?}
    
    H -->|å¦| I[ç§»åŠ¨mpâ†’n<br/>æ–°é”®å mp]
    H -->|æ˜¯| J[æ–°é”®æ”¾n<br/>é“¾æ¥åˆ°mp]
    
    G --> K[é‡æ–°æ’å…¥]
    D --> L[å®Œæˆ]
    I --> L
    J --> L
    
    style D fill:#c8e6c9,stroke:#388e3c
    style G fill:#ffcdd2,stroke:#c62828
    style I fill:#fff3e0,stroke:#e65100
    style J fill:#ffe0b2,stroke:#f57c00
```

**ğŸ“– è¯¦ç»†ç¤ºä¾‹**:

```
åœºæ™¯1ï¼šä¸»ä½ç½®ç©ºé—²
mp = Node[2] (empty)
æ“ä½œï¼šç›´æ¥æ’å…¥
ç»“æœï¼šNode[2] = {key, value, next=NULL}

åœºæ™¯2ï¼šä¸»ä½ç½®è¢«å ç”¨ï¼Œå ç”¨è€…åœ¨ä¸»ä½ç½®
mp = Node[2] = {key1, val1, next=NULL}
newkey = key2 (ä¸»ä½ç½®ä¹Ÿæ˜¯2)
ç©ºé—² = Node[5]

æ“ä½œï¼škey2æ”¾Node[5]ï¼Œé“¾æ¥åˆ°mp
ç»“æœï¼š
  Node[2] = {key1, val1, next=â†’5}
  Node[5] = {key2, val2, next=NULL}

åœºæ™¯3ï¼šä¸»ä½ç½®è¢«å ç”¨ï¼Œå ç”¨è€…ä¸åœ¨ä¸»ä½ç½® (Brentä¼˜åŒ–)
mp = Node[2] = {key1, val1, next=â†’4}  # key1ä¸»ä½ç½®æ˜¯1
newkey = key2 (ä¸»ä½ç½®æ˜¯2)
ç©ºé—² = Node[5]

æ“ä½œï¼šå°†key1ç§»åˆ°Node[5]ï¼Œkey2å æ®Node[2]
ç»“æœï¼š
  Node[1] = {key0, val0, next=â†’5}  # æ›´æ–°é“¾è¡¨
  Node[2] = {key2, val2, next=â†’4}  # key2å æ®ä¸»ä½ç½®
  Node[5] = {key1, val1, next=â†’4}  # key1è¢«ç§»åŠ¨
```

## ğŸ”„ è¡¨çš„é‡å“ˆå¸Œ (rehash)

å½“è¡¨ç©ºé—´ä¸è¶³æ—¶ï¼ŒLua ä¼šè¿›è¡Œé‡å“ˆå¸Œæ“ä½œï¼Œé‡æ–°åˆ†é…æ•°ç»„å’Œå“ˆå¸Œéƒ¨åˆ†çš„å¤§å°ã€‚

### è§¦å‘æ¡ä»¶

1. **ç©ºé—´è€—å°½**: `getfreepos()` è¿”å› NULL
2. **æ’å…¥æ–°é”®**: éœ€è¦ç©ºé—²ä½ç½®ä½†å“ˆå¸Œè¡¨å·²æ»¡
3. **åŠ¨æ€ä¼˜åŒ–**: æ ¹æ®ä½¿ç”¨æ¨¡å¼è°ƒæ•´æ•°ç»„/å“ˆå¸Œæ¯”ä¾‹

**ğŸ”„ Rehashå®Œæ•´æµç¨‹**:

```mermaid
flowchart TD
    A[è§¦å‘rehash] --> B[ç»Ÿè®¡å…ƒç´ åˆ†å¸ƒ<br/>nums æ•°ç»„]
    B --> C[è®¡ç®—æœ€ä¼˜æ•°ç»„å¤§å°<br/>computesizes]
    C --> D[ä¸ºæ–°é”®é¢„ç•™ç©ºé—´<br/>nasize++]
    D --> E[é‡æ–°åˆ†é…å†…å­˜<br/>resize]
    E --> F{é‡æ–°æ’å…¥<br/>æ‰€æœ‰é”®å€¼å¯¹}
    F -->|æ•°ç»„èŒƒå›´| G[æ’å…¥arrayéƒ¨åˆ†]
    F -->|å…¶ä»–é”®| H[æ’å…¥hashéƒ¨åˆ†]
    G --> I[å®Œæˆrehash]
    H --> I
    
    style A fill:#e1f5ff,stroke:#01579b
    style C fill:#fff3e0,stroke:#e65100
    style E fill:#ffcdd2,stroke:#c62828
    style I fill:#c8e6c9,stroke:#388e3c
```

```c
static void rehash (lua_State *L, Table *t, const TValue *ek) {
  int nasize, na;
  int nums[MAXBITS+1];  // ç»Ÿè®¡å„åŒºé—´çš„å…ƒç´ æ•°é‡
  int i;
  int totaluse;
  
  // 1. åˆå§‹åŒ–ç»Ÿè®¡æ•°ç»„
  for (i=0; i<=MAXBITS; i++) nums[i] = 0;
  
  // 2. ç»Ÿè®¡æ•°ç»„éƒ¨åˆ†çš„å…ƒç´ åˆ†å¸ƒ
  nasize = numusearray(t, nums);  // è¿”å›æ•°ç»„ä¸­énilå…ƒç´ æ•°é‡
  totaluse = nasize;
  
  // 3. ç»Ÿè®¡å“ˆå¸Œéƒ¨åˆ†çš„æ•´æ•°é”®
  totaluse += numusehash(t, nums, &nasize);
  
  // 4. ä¸ºæ–°é”®é¢„ç•™ç©ºé—´
  nasize++;
  totaluse++;
  
  // 5. è®¡ç®—æ–°çš„æ•°ç»„å¤§å°ï¼ˆæ»¡è¶³>=50%ä½¿ç”¨ç‡ï¼‰
  na = computesizes(nums, &nasize);
  
  // 6. é‡æ–°åˆ†é…å¹¶æ’å…¥
  resize(L, t, nasize, totaluse - na);
}
```

### å…ƒç´ ç»Ÿè®¡å‡½æ•°

```c
// ç»Ÿè®¡æ•°ç»„éƒ¨åˆ†çš„å…ƒç´ æ•°é‡
static int numusearray (const Table *t, int *nums) {
  int lg;
  int ttlg;  // 2^lg
  int ause = 0;  // ä½¿ç”¨çš„å…ƒç´ æ•°é‡
  int i = 1;  // æ•°ç»„ç´¢å¼•ä»1å¼€å§‹
  
  // æŒ‰2çš„å¹‚æ¬¡ç»Ÿè®¡: [1,2], [3,4], [5,8], [9,16], ...
  for (lg=0, ttlg=1; lg<=MAXBITS; lg++, ttlg*=2) {
    int lc = 0;  // å½“å‰åŒºé—´çš„è®¡æ•°
    int lim = ttlg;
    if (lim > t->sizearray) {
      lim = t->sizearray;
      if (i > lim) break;
    }
    // ç»Ÿè®¡åŒºé—´[i, lim]çš„énilå…ƒç´ 
    for (; i <= lim; i++) {
      if (!ttisnil(&t->array[i-1]))
        lc++;
    }
    nums[lg] += lc;
    ause += lc;
  }
  return ause;
}
```

**ğŸ“Š ç»Ÿè®¡ç¤ºä¾‹**:

```lua
-- ç¤ºä¾‹ï¼št = {[1]=a, [2]=b, [5]=c, [10]=d}
-- numsæ•°ç»„ç»Ÿè®¡ï¼š
-- nums[0-1]: åŒºé—´[1,2] â†’ 2ä¸ªå…ƒç´  (a, b)
-- nums[2-4]: åŒºé—´[3,4] â†’ 0ä¸ªå…ƒç´ 
-- nums[3-8]: åŒºé—´[5,8] â†’ 1ä¸ªå…ƒç´  (c)
-- nums[4-16]: åŒºé—´[9,16] â†’ 1ä¸ªå…ƒç´  (d)

-- è®¡ç®—æœ€ä¼˜æ•°ç»„å¤§å°ï¼š
--   n=2: ä½¿ç”¨2/2=100% âœ“
--   n=4: ä½¿ç”¨2/4=50% âœ“
--   n=8: ä½¿ç”¨3/8=37.5% âœ—
-- ç»“æœï¼šsizearray=4

-- å®é™…éœ€è¦16æ‰èƒ½å®¹çº³[10]ï¼Œä½†ä½¿ç”¨ç‡<50%
-- æœ€ç»ˆï¼šsizearray=4, [10]è¿›å…¥å“ˆå¸Œéƒ¨åˆ†
```

### Resizeæ“ä½œ

```c
static void resize (lua_State *L, Table *t, int nasize, int nhsize) {
  int i;
  int oldasize = t->sizearray;
  int oldhsize = t->lsizenode;
  Node *nold = t->node;  // ä¿å­˜æ—§å“ˆå¸Œè¡¨
  
  // 1. è°ƒæ•´æ•°ç»„å¤§å°
  if (nasize > oldasize)  // æ‰©å¤§æ•°ç»„
    setarrayvector(L, t, nasize);
    
  // 2. åˆ›å»ºæ–°å“ˆå¸Œè¡¨
  setnodevector(L, t, nhsize);
  
  // 3. ç¼©å°æ•°ç»„ï¼ˆå°†å¤šä½™å…ƒç´ ç§»åˆ°å“ˆå¸Œéƒ¨åˆ†ï¼‰
  if (nasize < oldasize) {
    t->sizearray = nasize;
    for (i=nasize; i<oldasize; i++) {
      if (!ttisnil(&t->array[i]))
        setobjt2t(L, luaH_setnum(L, t, i+1), &t->array[i]);
    }
    luaM_reallocvector(L, t->array, oldasize, nasize, TValue);
  }
  
  // 4. é‡æ–°æ’å…¥æ—§å“ˆå¸Œè¡¨çš„æ‰€æœ‰å…ƒç´ 
  for (i = twoto(oldhsize) - 1; i >= 0; i--) {
    Node *old = nold+i;
    if (!ttisnil(gval(old)))
      setobjt2t(L, luaH_set(L, t, key2tval(old)), gval(old));
  }
  
  // 5. é‡Šæ”¾æ—§å“ˆå¸Œè¡¨
  if (nold != dummynode)
    luaM_freearray(L, nold, twoto(oldhsize), Node);
}
```

**ğŸ“Š Rehashå‰åå¯¹æ¯”**:

```mermaid
graph TB
    subgraph "Rehashå‰"
        A1["array 4 <br/> 1,2,3,4 "]
        H1["hash 4 <br/> 5,name,6,7 <br/>å·²æ»¡ï¼"]
    end
    
    subgraph "æ’å…¥é”® 8 "
        T["è§¦å‘rehash"]
    end
    
    subgraph "Rehashå"
        A2["array 8 <br/> 1,2,3,4,5,6,7,8 "]
        H2["hash 2 <br/> name "]
    end
    
    A1 --> T
    H1 --> T
    T --> A2
    T --> H2
    
    style H1 fill:#ffcdd2,stroke:#c62828
    style T fill:#fff3e0,stroke:#e65100
    style A2 fill:#c8e6c9,stroke:#388e3c
    style H2 fill:#c8e6c9,stroke:#388e3c
```

**ğŸ“– å®Œæ•´ç¤ºä¾‹**:

```lua
-- åˆ›å»ºè¡¨å¹¶è§‚å¯Ÿrehash
local t = {}

-- é˜¶æ®µ1ï¼šåˆå§‹çŠ¶æ€
-- array=0, hash=0

-- é˜¶æ®µ2ï¼šæ’å…¥æ•´æ•°é”®
for i = 1, 4 do
    t[i] = i  
end
-- array=4, hash=0

-- é˜¶æ®µ3ï¼šæ’å…¥å­—ç¬¦ä¸²é”®
t["name"] = "Lua"
-- array=4, hash=1 (æœ€å°å“ˆå¸Œå¤§å°)

-- é˜¶æ®µ4ï¼šç»§ç»­æ’å…¥æ•´æ•°ï¼Œè§¦å‘rehash
for i = 5, 8 do
    t[i] = i
end
-- ç¬¬ä¸€æ¬¡rehash: array=8, hash=1

-- é˜¶æ®µ5ï¼šå¤§é‡æ’å…¥ï¼Œå¤šæ¬¡rehash
for i = 9, 100 do
    t[i] = i
end
-- å¤šæ¬¡rehashå: array=128, hash=1
-- ä½¿ç”¨ç‡: 100/128 = 78% (æ»¡è¶³>=50%)
```

### âš¡ æ€§èƒ½å½±å“åˆ†æ

| åœºæ™¯ | Rehashé¢‘ç‡ | æ—¶é—´å¤æ‚åº¦ | ä¼˜åŒ–å»ºè®® |
|------|------------|------------|----------|
| **é¡ºåºæ’å…¥** [1-n] | ä½ | O(n) å‡æ‘Š | é¢„åˆ†é…å¤§å° |
| **ç¨€ç–æ’å…¥** [1,100,200] | ä¸­ç­‰ | O(n) | ä½¿ç”¨å“ˆå¸Œéƒ¨åˆ† |
| **æ··åˆæ’å…¥** æ•´æ•°+å­—ç¬¦ä¸² | ä½ | O(n) | æ— éœ€ä¼˜åŒ– |
| **åˆ é™¤åæ’å…¥** | ä¸è§¦å‘ | O(1) | Rehashä¸å›æ”¶ç©ºé—´ |

**ğŸ’¡ ä¼˜åŒ–æŠ€å·§**:

```lua
-- æŠ€å·§1ï¼šé¢„åˆ†é…æ•°ç»„å¤§å°
local t = {[100] = nil}  -- åˆ›å»ºå¤§æ•°ç»„
for i = 1, 100 do
    t[i] = i  -- ä¸ä¼šè§¦å‘rehash
end

-- æŠ€å·§2ï¼šé¿å…ç¨€ç–æ•°ç»„
-- ä¸å¥½ï¼š{[1]=a, [1000]=b}  â†’ æµªè´¹å†…å­˜
-- æ›´å¥½ï¼š{[1]=a, index_1000=b}  â†’ ä½¿ç”¨å“ˆå¸Œ

-- æŠ€å·§3ï¼šæ‰¹é‡æ“ä½œ
-- ä¸å¥½ï¼šé€ä¸ªæ’å…¥è§¦å‘å¤šæ¬¡rehash
-- æ›´å¥½ï¼štable.move() æˆ–é¢„çŸ¥å¤§å°
```

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### æ—¶é—´å¤æ‚åº¦

| æ“ä½œ | æ•°ç»„éƒ¨åˆ† | å“ˆå¸Œéƒ¨åˆ† | æœ€åæƒ…å†µ |
|------|----------|----------|----------|
| **è®¿é—®** | O(1) | O(1) å¹³å‡ | O(n) å…¨å†²çª |
| **æ’å…¥** | O(1)* | O(1) å¹³å‡ | O(n) rehash |
| **åˆ é™¤** | O(1) | O(1) å¹³å‡ | O(n) éå†é“¾ |
| **é‡å“ˆå¸Œ** | O(n) | O(n) | O(n) |
| **éå†** | O(n) | O(n) | O(n) |

_*æ³¨ï¼šå¯èƒ½è§¦å‘O(n)çš„rehash_

### ç©ºé—´ä¼˜åŒ–

**ğŸ“Š å†…å­˜å ç”¨å¯¹æ¯”**:

```mermaid
graph LR
    subgraph "çº¯æ•°ç»„ 100å…ƒç´  "
        A1["array 128 <br/>128*16=2KB"]
    end
    
    subgraph "çº¯å“ˆå¸Œ 100å…ƒç´  "
        H1["hash 128 <br/>128*32=4KB"]
    end
    
    subgraph "æ··åˆæ¨¡å¼ 100å…ƒç´  "
        M1["array 128 <br/>2KB"]
        M2["hash 0 <br/>0KB"]
        M1 -.æ€»è®¡:2KB.-> M2
    end
    
    style A1 fill:#c8e6c9,stroke:#388e3c
    style H1 fill:#ffcdd2,stroke:#c62828
    style M1 fill:#a5d6a7,stroke:#2e7d32
```

**å†…å­˜ä½¿ç”¨è¯¦è§£**:

| å­˜å‚¨æ–¹å¼ | æ¯å…ƒç´ å¼€é”€ | 100ä¸ªå…ƒç´  | 1000ä¸ªå…ƒç´  |
|----------|------------|-----------|------------|
| **çº¯æ•°ç»„** | 16å­—èŠ‚ (TValue) | 2KB | 20KB |
| **çº¯å“ˆå¸Œ** | 32å­—èŠ‚ (Node) | 4KB | 40KB |
| **æ··åˆ(90%æ•°ç»„)** | ~17å­—èŠ‚ | 2.2KB | 21KB |

### ä½¿ç”¨åœºæ™¯å¯¹æ¯”

```lua
-- åœºæ™¯1ï¼šç¨ å¯†æ•°ç»„ (æœ€ä¼˜)
local array = {}
for i = 1, 1000 do
    array[i] = i
end
-- å†…å­˜ï¼š1024*16 = 16KB (æ•°ç»„)
-- è®¿é—®ï¼šO(1) ç›´æ¥ç´¢å¼•

-- åœºæ™¯2ï¼šç¨€ç–æ•°ç»„ (æ¬¡ä¼˜)
local sparse = {[1]=a, [1000]=b}
-- å†…å­˜ï¼š1*16 + 1*32 = 48B (æ•°ç»„+å“ˆå¸Œ)
-- Luaæ™ºèƒ½åˆ†é…ï¼šä¸ä¸ºä¸­é—´ç©ºæ´æµªè´¹ç©ºé—´

-- åœºæ™¯3ï¼šå­—å…¸ (å“ˆå¸Œ)
local dict = {name="Lua", version=5.1}
-- å†…å­˜ï¼š4*32 = 128B (æœ€å°å“ˆå¸Œå¤§å°)
-- è®¿é—®ï¼šO(1) å¹³å‡

-- åœºæ™¯4ï¼šæ··åˆ (çµæ´»)
local mixed = {
    "a", "b", "c",        -- [1-3] æ•°ç»„
    name = "Lua",          -- å“ˆå¸Œ
    version = 5.1,         -- å“ˆå¸Œ
    [100] = "large_index"  -- å“ˆå¸Œ (è¶…å‡ºæ•°ç»„åˆç†èŒƒå›´)
}
-- å†…å­˜ï¼š4*16 + 8*32 = 320B
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é¢„åˆ†é…æ•°ç»„å¤§å°

```lua
-- âŒ ä¸å¥½ï¼šå¤šæ¬¡rehash
local t = {}
for i = 1, 10000 do
    t[i] = i  -- è§¦å‘å¤šæ¬¡rehash: 1â†’2â†’4â†’8â†’...â†’16384
end

-- âœ… æ›´å¥½ï¼šé¢„åˆ†é…
local t = {}
t[10000] = nil  -- åˆ›å»ºå¤§å°ä¸º16384çš„æ•°ç»„
for i = 1, 10000 do
    t[i] = i  -- ä¸è§¦å‘rehash
end
```

### 2. é¿å…ç¨€ç–æ•°ç»„

```lua
-- âŒ ä¸å¥½ï¼šæµªè´¹å†…å­˜
local t = {
    [1] = "a",
    [1000000] = "b"  -- ä¼šå°è¯•åˆ›å»ºå¤§æ•°ç»„
}
-- å®é™…ï¼šä½¿ç”¨å“ˆå¸Œï¼Œä½†è®¡ç®—è¿‡ç¨‹æµªè´¹

-- âœ… æ›´å¥½ï¼šæ˜¾å¼ä½¿ç”¨å“ˆå¸Œ
local t = {
    ["key_1"] = "a",
    ["key_1000000"] = "b"
}
```

### 3. æ··åˆä½¿ç”¨æ—¶çš„é¡ºåº

```lua
-- âœ… æ¨èï¼šå…ˆæ’å…¥æ•°ç»„ï¼Œå†æ’å…¥å“ˆå¸Œ
local t = {}
-- 1. æ•°ç»„å…ƒç´ 
for i = 1, 100 do
    t[i] = i
end
-- 2. å“ˆå¸Œå…ƒç´ 
t.name = "Lua"
t.version = 5.1

-- åŸå› ï¼šé¿å…å…ˆåˆ†é…å¤§å“ˆå¸Œååˆè½¬ç§»åˆ°æ•°ç»„
```

### 4. åˆ é™¤ä¸ä¼šé‡Šæ”¾å†…å­˜

```lua
-- æ³¨æ„ï¼šåˆ é™¤å…ƒç´ ä¸ä¼šç¼©å°è¡¨
local t = {}
for i = 1, 10000 do
    t[i] = i
end
-- å†…å­˜ï¼š16KB

for i = 1, 10000 do
    t[i] = nil  -- åˆ é™¤æ‰€æœ‰å…ƒç´ 
end
-- å†…å­˜ï¼šä»ç„¶16KB (ä¸ä¼šrehashç¼©å°)

-- å¦‚éœ€é‡Šæ”¾å†…å­˜ï¼Œåˆ›å»ºæ–°è¡¨
t = {}  -- æ—§è¡¨ä¼šè¢«GCå›æ”¶
```

### 5. å…ƒè¡¨çš„æ€§èƒ½å½±å“

```lua
-- å…ƒè¡¨ä¼šå½±å“è®¿é—®æ€§èƒ½
local t = setmetatable({}, {
    __index = function(t, k)
        return 0  -- é»˜è®¤å€¼
    end
})

-- è®¿é—®ä¸å­˜åœ¨çš„é”®ä¼šè°ƒç”¨__index
local v = t.missing  -- è§¦å‘å…ƒæ–¹æ³•è°ƒç”¨

-- ä¼˜åŒ–ï¼šç¼“å­˜ç»“æœ
t.missing = t.missing  -- ç¬¬ä¸€æ¬¡è®¡ç®—åç¼“å­˜
```

## ğŸ” è°ƒè¯•å’Œå·¥å…·å‡½æ•°

### 1. è·å–è¡¨é•¿åº¦ (luaH_getn)

```c
int luaH_getn (Table *t) {
  int j = t->sizearray;
  if (j > 0 && ttisnil(&t->array[j - 1])) {
    // å­˜åœ¨ç©ºæ´ï¼Œéœ€è¦äºŒåˆ†æŸ¥æ‰¾
    int i = 0;
    while (j - i > 1) {
      int m = (i+j)/2;
      if (ttisnil(&t->array[m - 1])) j = m;
      else i = m;
    }
    return i;
  }
  else if (t->node != dummynode) {
    // æ£€æŸ¥å“ˆå¸Œéƒ¨åˆ†æ˜¯å¦æœ‰æ›´å¤§çš„æ•´æ•°é”®
    int i = 0;
    while (!ttisnil(luaH_getnum(t, j + 1 + i))) i++;
    return j + i;
  }
  else return j;
}
```

**ğŸ“– #è¿ç®—ç¬¦ç¤ºä¾‹**:

```lua
-- æƒ…å†µ1ï¼šæ— ç©ºæ´
local t1 = {1, 2, 3, 4, 5}
print(#t1)  -- 5 (ç›´æ¥è¿”å›sizearray)

-- æƒ…å†µ2ï¼šæœ‰ç©ºæ´
local t2 = {1, 2, nil, 4, 5}
print(#t2)  -- ä¸ç¡®å®šï¼å¯èƒ½æ˜¯2æˆ–5
-- Luaä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œç»“æœæœªå®šä¹‰

-- æƒ…å†µ3ï¼šå“ˆå¸Œéƒ¨åˆ†æœ‰æ•´æ•°é”®
local t3 = {1, 2, 3}
t3[10] = 10
print(#t3)  -- 10 (æ£€æŸ¥å“ˆå¸Œéƒ¨åˆ†)

-- æƒ…å†µ4ï¼šçº¯å“ˆå¸Œ
local t4 = {name="Lua"}
print(#t4)  -- 0 (æ²¡æœ‰æ•°ç»„éƒ¨åˆ†)
```

### 2. ä¸‹ä¸€ä¸ªé”®å€¼å¯¹ (luaH_next)

```c
int luaH_next (lua_State *L, Table *t, StkId key) {
  int i = findindex(L, t, key);  // æ‰¾åˆ°å½“å‰é”®çš„ä½ç½®
  
  // å°è¯•æ•°ç»„éƒ¨åˆ†
  for (i++; i < t->sizearray; i++) {
    if (!ttisnil(&t->array[i])) {
      setnvalue(key, cast_num(i+1));
      setobj2s(L, key+1, &t->array[i]);
      return 1;
    }
  }
  
  // ç»§ç»­åœ¨å“ˆå¸Œéƒ¨åˆ†æŸ¥æ‰¾
  for (i -= t->sizearray; i < sizenode(t); i++) {
    if (!ttisnil(gval(gnode(t, i)))) {
      setobj2s(L, key, key2tval(gnode(t, i)));
      setobj2s(L, key+1, gval(gnode(t, i)));
      return 1;
    }
  }
  
  return 0;  // æ²¡æœ‰æ›´å¤šå…ƒç´ 
}
```

**ğŸ“– pairséå†ç¤ºä¾‹**:

```lua
local t = {
    [1] = "a",
    [2] = "b",
    name = "Lua",
    version = 5.1
}

-- pairséå†é¡ºåºï¼š
-- 1. æ•°ç»„éƒ¨åˆ†æŒ‰é¡ºåº: 1, 2
-- 2. å“ˆå¸Œéƒ¨åˆ†æ— åº: name, version (æˆ– version, name)

for k, v in pairs(t) do
    print(k, v)
end
-- è¾“å‡ºï¼š
-- 1    a
-- 2    b
-- name    Lua
-- version    5.1
```

## ğŸ“š æ€»ç»“

Lua è¡¨çš„å®ç°æ˜¯ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡ä»¥ä¸‹ç‰¹æ€§å®ç°äº†ä¼˜å¼‚çš„æ€§èƒ½ï¼š

### ğŸ¯ æ ¸å¿ƒç‰¹ç‚¹

1. **æ··åˆå­˜å‚¨** ğŸ”€
   - æ•°ç»„å’Œå“ˆå¸Œè¡¨çš„å®Œç¾ç»“åˆ
   - é’ˆå¯¹ä¸åŒè®¿é—®æ¨¡å¼è‡ªåŠ¨ä¼˜åŒ–
   - æ•´æ•°é”®ç”¨æ•°ç»„ï¼Œå…¶ä»–é”®ç”¨å“ˆå¸Œ

2. **åŠ¨æ€è°ƒæ•´** ğŸ“Š
   - æ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªåŠ¨rehash
   - 50%ä½¿ç”¨ç‡åŸåˆ™å¹³è¡¡ç©ºé—´å’Œæ€§èƒ½
   - æ™ºèƒ½åˆ¤æ–­æ•°ç»„/å“ˆå¸Œæ¯”ä¾‹

3. **é«˜æ•ˆå“ˆå¸Œ** âš¡
   - Brentå˜ç§ç®—æ³•ä¼˜åŒ–å†²çªé“¾
   - ä¸åŒç±»å‹é”®ä½¿ç”¨ä¸“ç”¨å“ˆå¸Œå‡½æ•°
   - lastfreeæŒ‡é’ˆåŠ é€Ÿç©ºé—²ä½ç½®æŸ¥æ‰¾

4. **å…ƒæ–¹æ³•ç¼“å­˜** ğŸ­
   - flagsä½å›¾é¿å…é‡å¤å…ƒè¡¨æŸ¥æ‰¾
   - 8ä¸ªå¸¸ç”¨å…ƒæ–¹æ³•çš„å¿«é€Ÿåˆ¤æ–­
   - æ˜¾è‘—æå‡è®¿é—®æ€§èƒ½

5. **å†…å­˜ä¼˜åŒ–** ğŸ’¾
   - åªåœ¨éœ€è¦æ—¶åˆ†é…å“ˆå¸Œéƒ¨åˆ†
   - æ•°ç»„éƒ¨åˆ†è¿ç»­å­˜å‚¨ï¼Œç¼“å­˜å‹å¥½
   - æ¯ä¸ªæ•°ç»„å…ƒç´ 16å­—èŠ‚ï¼Œå“ˆå¸ŒèŠ‚ç‚¹32å­—èŠ‚

### ğŸ“Š æ€§èƒ½æ€»è§ˆ

| ç‰¹æ€§ | æ•°ç»„éƒ¨åˆ† | å“ˆå¸Œéƒ¨åˆ† |
|------|----------|----------|
| **è®¿é—®é€Ÿåº¦** | O(1) æå¿« | O(1) å¹³å‡å¿« |
| **å†…å­˜å¼€é”€** | 16B/å…ƒç´  | 32B/å…ƒç´  |
| **é€‚ç”¨åœºæ™¯** | å¯†é›†æ•´æ•°ç´¢å¼• | ä»»æ„é”®ç±»å‹ |
| **æ‰©å®¹ç­–ç•¥** | 2çš„å¹‚æ¬¡å¢é•¿ | 2çš„å¹‚æ¬¡å¢é•¿ |
| **ä½¿ç”¨ç‡è¦æ±‚** | â‰¥50% | æŒ‰éœ€åˆ†é… |

### ğŸš€ ä½¿ç”¨å»ºè®®

**DO âœ…**:
- ä½¿ç”¨è¿ç»­æ•´æ•°é”®åˆ›å»ºæ•°ç»„
- é¢„åˆ†é…å·²çŸ¥å¤§å°çš„è¡¨
- æ··åˆä½¿ç”¨æ—¶å…ˆæ’å…¥æ•°ç»„å…ƒç´ 
- åˆ©ç”¨å±€éƒ¨å˜é‡ç¼“å­˜è¡¨å­—æ®µ

**DON'T âŒ**:
- é¿å…åˆ›å»ºè¶…å¤§ç¨€ç–æ•°ç»„
- é¿å…nilé”®ï¼ˆä¼šæŠ¥é”™ï¼‰
- ä¸è¦æœŸæœ›åˆ é™¤æ“ä½œé‡Šæ”¾å†…å­˜
- ä¸è¦ä¾èµ–#è¿ç®—ç¬¦å¤„ç†å¸¦ç©ºæ´çš„æ•°ç»„

### ğŸ”¬ å…¸å‹ä½¿ç”¨æ¨¡å¼

```lua
-- 1. æ•°ç»„ï¼ˆæœ€é«˜æ•ˆï¼‰
local array = {1, 2, 3, 4, 5}

-- 2. å­—å…¸ï¼ˆå¸¸ç”¨ï¼‰
local dict = {name="Lua", version=5.1}

-- 3. å¯¹è±¡ï¼ˆOOPé£æ ¼ï¼‰
local obj = {x=10, y=20}
function obj:move(dx, dy)
    self.x = self.x + dx
    self.y = self.y + dy
end

-- 4. æ··åˆï¼ˆçµæ´»ï¼‰
local data = {
    "item1", "item2",  -- æ•°ç»„éƒ¨åˆ†
    count = 2,          -- å“ˆå¸Œéƒ¨åˆ†
    config = {...}      -- åµŒå¥—è¡¨
}
```

### ğŸ§© è®¾è®¡å“²å­¦

Luaè¡¨ä½“ç°äº†ä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š

1. **ç®€å•æ€§** - å•ä¸€æ•°æ®ç»“æ„å®ç°å¤šç§ç”¨é€”
2. **é«˜æ•ˆæ€§** - O(1)è®¿é—®ï¼Œæ™ºèƒ½å†…å­˜ç®¡ç†
3. **çµæ´»æ€§** - å¯ä½œä¸ºæ•°ç»„ã€å­—å…¸ã€å¯¹è±¡ã€æ¨¡å—
4. **é€æ˜æ€§** - ç”¨æˆ·æ— éœ€å…³å¿ƒå†…éƒ¨å®ç°
5. **ä¼˜é›…æ€§** - æœ€å°åŒ–æ¦‚å¿µï¼Œæœ€å¤§åŒ–åŠŸèƒ½

è¿™ç§è®¾è®¡ä½¿å¾— Lua è¡¨åœ¨å„ç§ä½¿ç”¨åœºæ™¯ä¸‹éƒ½èƒ½ä¿æŒé«˜æ•ˆï¼Œæ— è®ºæ˜¯ä½œä¸ºæ•°ç»„ã€å­—å…¸è¿˜æ˜¯å¯¹è±¡ä½¿ç”¨ï¼Œéƒ½èƒ½æä¾›ä¸€è‡´ä¸”ä¼˜ç§€çš„æ€§èƒ½è¡¨ç°ã€‚è¿™æ­£æ˜¯Luaè¢«å¹¿æ³›åº”ç”¨äºæ¸¸æˆå¼€å‘ã€åµŒå…¥å¼ç³»ç»Ÿå’Œè„šæœ¬ç¼–ç¨‹çš„é‡è¦åŸå› ä¹‹ä¸€ã€‚

---

**ğŸ”— ç›¸å…³æ–‡æ¡£**:
- ğŸ“– [å‡½æ•°ç³»ç»Ÿ (wiki_function.md)](wiki_function.md) - äº†è§£å‡½æ•°å’Œé—­åŒ…çš„å®ç°
- ğŸ–¥ï¸ [è™šæ‹Ÿæœºæ‰§è¡Œ (wiki_vm.md)](wiki_vm.md) - äº†è§£è¡¨æ“ä½œçš„å­—èŠ‚ç 
- ğŸ—‘ï¸ [åƒåœ¾å›æ”¶å™¨ (wiki_gc.md)](wiki_gc.md) - äº†è§£è¡¨çš„å†…å­˜ç®¡ç†
- ğŸ“ [å¯¹è±¡æ¨¡å‹ (wiki_object.md)](wiki_object.md) - äº†è§£TValueå’Œç±»å‹ç³»ç»Ÿ

**ğŸ“š è¿›é˜¶é˜…è¯»**:
- ã€ŠLuaç¨‹åºè®¾è®¡ï¼ˆç¬¬4ç‰ˆï¼‰ã€‹ç¬¬3ç«  - è¡¨çš„ä½¿ç”¨
- Lua 5.1æºç  `ltable.c` - è¡¨çš„å®Œæ•´å®ç°
- "The Implementation of Lua 5.0" è®ºæ–‡ - è¡¨çš„è®¾è®¡æ€æƒ³
- Lua-users wiki: TablesTutorial - è¡¨çš„æœ€ä½³å®è·µ