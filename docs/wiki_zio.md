# Lua è¾“å…¥æµç³»ç»Ÿ (lzio.h/lzio.c) è¯¦ç»†åˆ†æ

## ğŸ“– æ¦‚è¿°

`lzio.h` å’Œ `lzio.c` æ–‡ä»¶å®ç°äº† Lua çš„é€šç”¨è¾“å…¥æµæ¥å£ï¼Œæä¾›äº†ç¼“å†²æµçš„æŠ½è±¡å±‚ã€‚è¿™ä¸ªæ¨¡å—ä¸º Lua çš„è¯æ³•åˆ†æå™¨ã€è§£æå™¨å’Œå…¶ä»–éœ€è¦å­—ç¬¦è¾“å…¥çš„ç»„ä»¶æä¾›äº†ç»Ÿä¸€çš„è¾“å…¥æ¥å£ï¼Œæ”¯æŒä»ä¸åŒæ•°æ®æºï¼ˆæ–‡ä»¶ã€å­—ç¬¦ä¸²ã€å†…å­˜ç­‰ï¼‰è¯»å–æ•°æ®ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- âœ… **ç»Ÿä¸€è¾“å…¥æŠ½è±¡** - å°†å„ç§è¾“å…¥æºæŠ½è±¡ä¸ºä¸€è‡´çš„æµæ¥å£
- âš¡ **é«˜æ•ˆç¼“å†²æœºåˆ¶** - é€šè¿‡é¢„è¯»å’Œç¼“å†²å‡å°‘I/Oæ“ä½œæ¬¡æ•°
- ğŸ”Œ **å¯æ‰©å±•è®¾è®¡** - ä½¿ç”¨å‡½æ•°æŒ‡é’ˆå®ç°çµæ´»çš„è¾“å…¥æºæ”¯æŒ
- ğŸ’¾ **åŠ¨æ€å†…å­˜ç®¡ç†** - æ ¹æ®éœ€è¦è‡ªåŠ¨è°ƒæ•´ç¼“å†²åŒºå¤§å°
- ğŸ”’ **çº¿ç¨‹å®‰å…¨** - é€‚å½“çš„é”ç®¡ç†ä¿è¯å¹¶å‘å®‰å…¨

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "æ•°æ®æºå±‚"
        A1[æ–‡ä»¶ FILE*]
        A2[å­—ç¬¦ä¸² String]
        A3[ç½‘ç»œ Socket]
        A4[è‡ªå®šä¹‰æº Custom]
    end
    
    subgraph "ZIOè¾“å…¥æµå±‚"
        B1[lua_Reader å›è°ƒå‡½æ•°]
        B2[ZIO æµå¯¹è±¡]
        B3[å†…éƒ¨ç¼“å†²åŒº]
    end
    
    subgraph "ä¸Šå±‚åº”ç”¨"
        C1[è¯æ³•åˆ†æå™¨ llex]
        C2[è§£æå™¨ lparser]
        C3[å­—èŠ‚ç åŠ è½½ lundump]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    B3 --> C2
    B3 --> C3
    
    style B2 fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    style B3 fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style C1 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style C2 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style C3 fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
```

## ğŸ”§ æ ¸å¿ƒæ•°æ®ç»“æ„

### 1. ZIO ç»“æ„ä½“ (è¾“å…¥æµ)

```c
struct Zio {
  size_t n;           // ç¼“å†²åŒºä¸­å‰©ä½™æœªè¯»å­—èŠ‚æ•°
  const char *p;      // å½“å‰åœ¨ç¼“å†²åŒºä¸­çš„ä½ç½®æŒ‡é’ˆ
  lua_Reader reader;  // è¯»å–å‡½æ•°æŒ‡é’ˆ
  void* data;         // ä¼ é€’ç»™è¯»å–å‡½æ•°çš„é¢å¤–æ•°æ®
  lua_State *L;       // Lua çŠ¶æ€æœºï¼ˆç”¨äºè¯»å–å‡½æ•°ï¼‰
};
```

**ğŸ’¡ åŠŸèƒ½**: ZIO æ˜¯è¾“å…¥æµçš„æ ¸å¿ƒç»“æ„ï¼Œå°è£…äº†ç¼“å†²åŒºçŠ¶æ€å’Œè¯»å–é€»è¾‘ã€‚

**ğŸ“‹ å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `n` | `size_t` | å½“å‰ç¼“å†²åŒºä¸­è¿˜æœ‰å¤šå°‘å­—èŠ‚æœªè¯» |
| `p` | `const char*` | æŒ‡å‘ç¼“å†²åŒºä¸­ä¸‹ä¸€ä¸ªè¦è¯»å–çš„å­—ç¬¦ |
| `reader` | `lua_Reader` | å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºä»åº•å±‚æ•°æ®æºè¯»å–æ•°æ® |
| `data` | `void*` | ä¼ é€’ç»™ reader å‡½æ•°çš„ç”¨æˆ·æ•°æ® |
| `L` | `lua_State*` | Lua çŠ¶æ€æœºï¼Œç”¨äºå†…å­˜ç®¡ç†å’Œé”™è¯¯å¤„ç† |

**ğŸ”„ çŠ¶æ€è½¬æ¢å›¾**:

```mermaid
stateDiagram-v2
    [*] --> åˆå§‹åŒ–: luaZ_init()
    åˆå§‹åŒ– --> ç¼“å†²åŒºç©º: n=0, p=NULL
    ç¼“å†²åŒºç©º --> å¡«å……ä¸­: è°ƒç”¨ luaZ_fill()
    å¡«å……ä¸­ --> ç¼“å†²åŒºæœ‰æ•°æ®: readerè¿”å›æ•°æ®
    å¡«å……ä¸­ --> æµç»“æŸ: readerè¿”å›NULL
    ç¼“å†²åŒºæœ‰æ•°æ® --> è¯»å–å­—ç¬¦: zgetc()
    è¯»å–å­—ç¬¦ --> ç¼“å†²åŒºæœ‰æ•°æ®: n > 0
    è¯»å–å­—ç¬¦ --> ç¼“å†²åŒºç©º: n = 0
    æµç»“æŸ --> [*]
```

### 2. Mbuffer ç»“æ„ä½“ (å†…å­˜ç¼“å†²åŒº)

```c
typedef struct Mbuffer {
  char *buffer;     // ç¼“å†²åŒºæŒ‡é’ˆ
  size_t n;         // å½“å‰ç¼“å†²åŒºä¸­çš„æ•°æ®é•¿åº¦
  size_t buffsize;  // ç¼“å†²åŒºæ€»å¤§å°
} Mbuffer;
```

**ğŸ’¡ åŠŸèƒ½**: å¯åŠ¨æ€è°ƒæ•´å¤§å°çš„å†…å­˜ç¼“å†²åŒºï¼Œç”¨äºä¸´æ—¶å­˜å‚¨æ•°æ®ã€‚

**ğŸ“‹ å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `buffer` | `char*` | æŒ‡å‘å®é™…çš„å†…å­˜ç¼“å†²åŒº |
| `n` | `size_t` | å½“å‰ç¼“å†²åŒºä¸­æœ‰æ•ˆæ•°æ®çš„é•¿åº¦ |
| `buffsize` | `size_t` | ç¼“å†²åŒºçš„æ€»å®¹é‡ |

**ğŸ“Š å†…å­˜å¸ƒå±€ç¤ºæ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mbuffer ç»“æ„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  buffer â”€â”€â”€â”€â”                       â”‚
â”‚  n = 10     â”‚                       â”‚
â”‚  buffsize=20â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æœ‰æ•ˆæ•°æ® (n=10)â”‚   æœªä½¿ç”¨   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â—„â”€â”€â”€â”€â”€â”€10å­—èŠ‚â”€â”€â”€â”€â–ºâ—„â”€â”€â”€10å­—èŠ‚â”€â”€â–º
    â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€20å­—èŠ‚ (buffsize)â”€â”€â”€â”€â–º
```

## âš™ï¸ æ ¸å¿ƒå®å®šä¹‰

### 1. æµæ“ä½œå®

```c
#define EOZ (-1)  // æµç»“æŸæ ‡å¿—

#define char2int(c) cast(int, cast(unsigned char, (c)))

#define zgetc(z) (((z)->n--)>0 ? char2int(*(z)->p++) : luaZ_fill(z))
```

**ğŸ“ åŠŸèƒ½è¯´æ˜**:

| å® | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|---|---|---|
| `EOZ` | è¡¨ç¤ºæµç»“æŸçš„ç‰¹æ®Šå€¼ | æ£€æµ‹æ˜¯å¦åˆ°è¾¾æµæœ«å°¾ |
| `char2int` | å°†å­—ç¬¦å®‰å…¨è½¬æ¢ä¸ºæ•´æ•° | é¿å…ç¬¦å·æ‰©å±•é—®é¢˜ |
| `zgetc` | é«˜æ•ˆçš„å­—ç¬¦è¯»å– | è¯æ³•åˆ†æä¸­çš„æ ¸å¿ƒè¯»å–æ“ä½œ |

**ğŸ” zgetc å®çš„æ‰§è¡Œæµç¨‹**:

```mermaid
flowchart TD
    A[è°ƒç”¨ zgetc] --> B{n > 0?}
    B -->|æ˜¯| C[n--]
    C --> D[è¿”å› *p++]
    B -->|å¦| E[è°ƒç”¨ luaZ_fill]
    E --> F{è¿”å›å€¼}
    F -->|æˆåŠŸ| G[è¿”å›æ–°å­—ç¬¦]
    F -->|å¤±è´¥| H[è¿”å› EOZ]
    
    style A fill:#e3f2fd,stroke:#1976d2
    style D fill:#c8e6c9,stroke:#388e3c
    style G fill:#c8e6c9,stroke:#388e3c
    style H fill:#ffcdd2,stroke:#c62828
```

**ğŸ’¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**:
- âš¡ **å¿«é€Ÿè·¯å¾„**: å½“ç¼“å†²åŒºæœ‰æ•°æ®æ—¶ï¼Œåªéœ€ç®€å•çš„æŒ‡é’ˆæ“ä½œ
- ğŸ¢ **æ…¢é€Ÿè·¯å¾„**: ç¼“å†²åŒºç©ºæ—¶æ‰è°ƒç”¨å‡½æ•°å¡«å……
- ğŸ¯ **åˆ†æ”¯é¢„æµ‹**: å¤§å¤šæ•°æƒ…å†µä¸‹èµ°å¿«é€Ÿè·¯å¾„ï¼Œåˆ©äºCPUåˆ†æ”¯é¢„æµ‹

### 2. ç¼“å†²åŒºç®¡ç†å®

```c
#define luaZ_initbuffer(L, buff) ((buff)->buffer = NULL, (buff)->buffsize = 0)

#define luaZ_buffer(buff)     ((buff)->buffer)
#define luaZ_sizebuffer(buff) ((buff)->buffsize)
#define luaZ_bufflen(buff)    ((buff)->n)

#define luaZ_resetbuffer(buff) ((buff)->n = 0)

#define luaZ_resizebuffer(L, buff, size) \
  (luaM_reallocvector(L, (buff)->buffer, (buff)->buffsize, size, char), \
   (buff)->buffsize = size)

#define luaZ_freebuffer(L, buff) luaZ_resizebuffer(L, buff, 0)
```

**ğŸ“‹ ç¼“å†²åŒºæ“ä½œæ€»è§ˆ**:

| å® | åŠŸèƒ½ | å†…å­˜æ“ä½œ |
|---|---|---|
| `luaZ_initbuffer` | åˆå§‹åŒ–ç¼“å†²åŒº | âŒ ä¸åˆ†é… |
| `luaZ_buffer` | è·å–ç¼“å†²åŒºæŒ‡é’ˆ | âŒ åªè¯» |
| `luaZ_sizebuffer` | è·å–ç¼“å†²åŒºå¤§å° | âŒ åªè¯» |
| `luaZ_bufflen` | è·å–æœ‰æ•ˆæ•°æ®é•¿åº¦ | âŒ åªè¯» |
| `luaZ_resetbuffer` | é‡ç½®ç¼“å†²åŒº | âŒ ä¸é‡Šæ”¾ |
| `luaZ_resizebuffer` | è°ƒæ•´ç¼“å†²åŒºå¤§å° | âœ… é‡æ–°åˆ†é… |
| `luaZ_freebuffer` | é‡Šæ”¾ç¼“å†²åŒº | âœ… å®Œå…¨é‡Šæ”¾ |

**ğŸ”„ ç¼“å†²åŒºç”Ÿå‘½å‘¨æœŸ**:

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ä»£ç 
    participant Buff as Mbuffer
    participant Mem as å†…å­˜ç®¡ç†å™¨
    
    App->>Buff: luaZ_initbuffer()
    Note over Buff: buffer=NULL, buffsize=0
    
    App->>Buff: luaZ_openspace(100)
    Buff->>Mem: åˆ†é…100å­—èŠ‚
    Mem-->>Buff: è¿”å›æŒ‡é’ˆ
    Note over Buff: buffer=ptr, buffsize=100
    
    App->>Buff: å†™å…¥æ•°æ®
    Note over Buff: n=50 (æœ‰æ•ˆæ•°æ®)
    
    App->>Buff: luaZ_resetbuffer()
    Note over Buff: n=0 (å†…å­˜ä¿ç•™)
    
    App->>Buff: luaZ_freebuffer()
    Buff->>Mem: é‡Šæ”¾å†…å­˜
    Note over Buff: buffer=NULL, buffsize=0
    
    style Buff fill:#fff3e0,stroke:#e65100
    style Mem fill:#e1f5ff,stroke:#01579b
```

## ğŸ”‘ å…³é”®å‡½æ•°è¯¦ç»†åˆ†æ

### 1. æµåˆå§‹åŒ–å‡½æ•° - luaZ_init

```c
void luaZ_init (lua_State *L, ZIO *z, lua_Reader reader, void *data)
```

**ğŸ’¡ åŠŸèƒ½**: åˆå§‹åŒ–è¾“å…¥æµ

**ğŸ“¥ å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `L` | `lua_State*` | Lua çŠ¶æ€æœº |
| `z` | `ZIO*` | è¦åˆå§‹åŒ–çš„ ZIO ç»“æ„ |
| `reader` | `lua_Reader` | è¯»å–å‡½æ•°æŒ‡é’ˆ |
| `data` | `void*` | ä¼ é€’ç»™è¯»å–å‡½æ•°çš„ç”¨æˆ·æ•°æ® |

**ğŸ”„ å®ç°é€»è¾‘**:
```c
void luaZ_init (lua_State *L, ZIO *z, lua_Reader reader, void *data) {
  z->L = L;        // â‘  è®¾ç½® Lua çŠ¶æ€æœº
  z->reader = reader;   // â‘¡ è®¾ç½®è¯»å–å™¨å‡½æ•°
  z->data = data;       // â‘¢ è®¾ç½®ç”¨æˆ·æ•°æ®
  z->n = 0;             // â‘£ åˆå§‹ç¼“å†²åŒºä¸ºç©º
  z->p = NULL;          // â‘¤ æ— æœ‰æ•ˆç¼“å†²åŒºæŒ‡é’ˆ
}
```

**ğŸ“– ä½¿ç”¨ç¤ºä¾‹**:

```c
// ç¤ºä¾‹1: ä»å­—ç¬¦ä¸²åˆ›å»ºZIOæµ
const char* string_reader(lua_State *L, void *data, size_t *size) {
    const char **pstr = (const char **)data;
    if (*pstr == NULL) return NULL;  // å·²è¯»å®Œ
    *size = strlen(*pstr);
    const char *result = *pstr;
    *pstr = NULL;  // æ ‡è®°ä¸ºå·²è¯»
    return result;
}

lua_State *L = luaL_newstate();
const char *script = "print('Hello')";
const char *data = script;

ZIO z;
luaZ_init(L, &z, string_reader, &data);

// ç°åœ¨å¯ä»¥ä» z è¯»å–å­—ç¬¦
int c = zgetc(&z);  // è¯»å– 'p'
```

### 2. ç¼“å†²åŒºå¡«å……å‡½æ•° - luaZ_fill

```c
int luaZ_fill (ZIO *z)
```

**ğŸ’¡ åŠŸèƒ½**: ä»åº•å±‚æ•°æ®æºå¡«å……ç¼“å†²åŒº

**â†©ï¸ è¿”å›å€¼**: è¯»å–åˆ°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœåˆ°è¾¾æµæœ«å°¾åˆ™è¿”å› `EOZ`

**ğŸ”„ æ‰§è¡Œæµç¨‹å›¾**:

```mermaid
flowchart TD
    A[luaZ_fill è¢«è°ƒç”¨] --> B[è§£é” lua_unlock]
    B --> C[è°ƒç”¨ reader å‡½æ•°]
    C --> D[é‡æ–°åŠ é” lua_lock]
    D --> E{buff == NULL<br/>æˆ– size == 0?}
    E -->|æ˜¯| F[è¿”å› EOZ]
    E -->|å¦| G[è®¾ç½® n = size - 1]
    G --> H[è®¾ç½® p = buff]
    H --> I[è¿”å›ç¬¬ä¸€ä¸ªå­—ç¬¦<br/>char2int]
    
    style A fill:#e3f2fd,stroke:#1976d2
    style C fill:#fff3e0,stroke:#e65100
    style F fill:#ffcdd2,stroke:#c62828
    style I fill:#c8e6c9,stroke:#388e3c
```

**ğŸ” å®ç°é€»è¾‘**:
```c
int luaZ_fill (ZIO *z) {
  size_t size;
  lua_State *L = z->L;
  const char *buff;
  
  lua_unlock(L);                    // â‘  è§£é”ï¼Œå…è®¸è¯»å–å‡½æ•°æ‰§è¡Œ
  buff = z->reader(L, z->data, &size);  // â‘¡ è°ƒç”¨è¯»å–å‡½æ•°
  lua_lock(L);                      // â‘¢ é‡æ–°åŠ é”
  
  if (buff == NULL || size == 0)   // â‘£ è¯»å–å¤±è´¥æˆ–åˆ°è¾¾æœ«å°¾
    return EOZ;
    
  z->n = size - 1;                 // â‘¤ è®¾ç½®å‰©ä½™å­—èŠ‚æ•°ï¼ˆå‡1å› ä¸ºè¦è¿”å›ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
  z->p = buff;                     // â‘¥ è®¾ç½®ç¼“å†²åŒºæŒ‡é’ˆ
  
  return char2int(*(z->p++));      // â‘¦ è¿”å›ç¬¬ä¸€ä¸ªå­—ç¬¦å¹¶ç§»åŠ¨æŒ‡é’ˆ
}
```

**âš¡ å…³é”®ç‰¹æ€§**:
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**: åœ¨è°ƒç”¨ç”¨æˆ·æä¾›çš„è¯»å–å‡½æ•°æ—¶è§£é”å’Œé‡æ–°åŠ é”
- âœ… **é”™è¯¯å¤„ç†**: æ£€æŸ¥è¯»å–å‡½æ•°çš„è¿”å›å€¼
- ğŸš€ **æ•ˆç‡ä¼˜åŒ–**: ç«‹å³è¿”å›ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼Œé¿å…é¢å¤–çš„è¯»å–è°ƒç”¨

### 3. å‰ç»è¯»å–å‡½æ•° - luaZ_lookahead

```c
int luaZ_lookahead (ZIO *z)
```

**ğŸ’¡ åŠŸèƒ½**: æŸ¥çœ‹ä¸‹ä¸€ä¸ªå­—ç¬¦ä½†ä¸æ¶ˆè´¹å®ƒï¼ˆéç ´åæ€§è¯»å–ï¼‰

**â†©ï¸ è¿”å›å€¼**: ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœåˆ°è¾¾æµæœ«å°¾åˆ™è¿”å› `EOZ`

**ğŸ” å®ç°é€»è¾‘**:
```c
int luaZ_lookahead (ZIO *z) {
  if (z->n == 0) {                 // â‘  ç¼“å†²åŒºä¸ºç©º
    if (luaZ_fill(z) == EOZ)       // â‘¡ å°è¯•å¡«å……ç¼“å†²åŒº
      return EOZ;                  // â‘¢ åˆ°è¾¾æµæœ«å°¾
    else {
      z->n++;                      // â‘£ æ¢å¤å­—èŠ‚è®¡æ•°ï¼ˆæ’¤é”€fillçš„æ¶ˆè´¹ï¼‰
      z->p--;                      // â‘¤ å›é€€æŒ‡é’ˆ
    }
  }
  return char2int(*z->p);          // â‘¥ è¿”å›å½“å‰å­—ç¬¦ä½†ä¸ç§»åŠ¨æŒ‡é’ˆ
}
```

**ğŸ­ å¯¹æ¯”: lookahead vs zgetc**:

```mermaid
graph LR
    subgraph "luaZ_lookahead (å‰ç»)"
        A1[æŸ¥çœ‹å­—ç¬¦] --> A2[ä¸ç§»åŠ¨æŒ‡é’ˆ]
        A2 --> A3[å¯é‡å¤è¯»å–]
    end
    
    subgraph "zgetc (è¯»å–)"
        B1[è¯»å–å­—ç¬¦] --> B2[ç§»åŠ¨æŒ‡é’ˆ]
        B2 --> B3[æ¶ˆè´¹å­—ç¬¦]
    end
    
    style A1 fill:#e3f2fd,stroke:#1976d2
    style B1 fill:#fff3e0,stroke:#e65100
```

**ğŸ“– ä½¿ç”¨åœºæ™¯ç¤ºä¾‹**:

```c
// è¯æ³•åˆ†æå™¨ä¸­åˆ¤æ–­æ•°å­—ç±»å‹
ZIO *z = /* ... */;
int c = luaZ_lookahead(z);  // å‰ç»ä¸‹ä¸€ä¸ªå­—ç¬¦

if (c == 'x' || c == 'X') {
    // æ˜¯åå…­è¿›åˆ¶æ•° 0x...
    zgetc(z);  // æ¶ˆè´¹ 'x'
    // è§£æåå…­è¿›åˆ¶æ•°å­—
} else if (isdigit(c)) {
    // æ˜¯åè¿›åˆ¶æ•°
    // ç»§ç»­è§£æ
}

// lookaheadåï¼Œä¸‹æ¬¡zgetcä»ä¼šè¯»åˆ°åŒä¸€ä¸ªå­—ç¬¦
```

### 4. æ‰¹é‡è¯»å–å‡½æ•° - luaZ_read

```c
size_t luaZ_read (ZIO *z, void *b, size_t n)
```

**ğŸ’¡ åŠŸèƒ½**: ä»æµä¸­è¯»å–æŒ‡å®šæ•°é‡çš„å­—èŠ‚

**ğŸ“¥ å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `z` | `ZIO*` | è¾“å…¥æµ |
| `b` | `void*` | ç›®æ ‡ç¼“å†²åŒº |
| `n` | `size_t` | è¦è¯»å–çš„å­—èŠ‚æ•° |

**â†©ï¸ è¿”å›å€¼**: æœªèƒ½è¯»å–çš„å­—èŠ‚æ•°ï¼ˆ0è¡¨ç¤ºå…¨éƒ¨è¯»å–æˆåŠŸï¼‰

**ğŸ”„ è¯»å–æµç¨‹**:

```mermaid
flowchart TD
    A[å¼€å§‹è¯»å– n å­—èŠ‚] --> B{n > 0?}
    B -->|å¦| C[è¿”å› 0<br/>å®Œå…¨æˆåŠŸ]
    B -->|æ˜¯| D[å‰ç»æ£€æŸ¥ lookahead]
    D --> E{è¿”å› EOZ?}
    E -->|æ˜¯| F[è¿”å› n<br/>å‰©ä½™æœªè¯»]
    E -->|å¦| G[è®¡ç®—æœ¬æ¬¡å¯è¯»<br/>m = min]
    G --> H[memcpy å¤åˆ¶æ•°æ®]
    H --> I[æ›´æ–°æŒ‡é’ˆå’Œè®¡æ•°]
    I --> J[n -= m]
    J --> B
    
    style C fill:#c8e6c9,stroke:#388e3c
    style F fill:#ffcdd2,stroke:#c62828
    style H fill:#fff3e0,stroke:#e65100
```

**ğŸ” å®ç°é€»è¾‘**:
```c
size_t luaZ_read (ZIO *z, void *b, size_t n) {
  while (n) {
    size_t m;
    if (luaZ_lookahead(z) == EOZ)    // â‘  æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æµæœ«å°¾
      return n;                      // â‘¡ è¿”å›å‰©ä½™æœªè¯»å­—èŠ‚æ•°
    m = (n <= z->n) ? n : z->n;      // â‘¢ è®¡ç®—æœ¬æ¬¡å¯è¯»å–çš„å­—èŠ‚æ•°
    memcpy(b, z->p, m);              // â‘£ å¤åˆ¶æ•°æ®
    z->n -= m;                       // â‘¤ æ›´æ–°å‰©ä½™å­—èŠ‚æ•°
    z->p += m;                       // â‘¥ ç§»åŠ¨ç¼“å†²åŒºæŒ‡é’ˆ
    b = (char *)b + m;               // â‘¦ ç§»åŠ¨ç›®æ ‡æŒ‡é’ˆ
    n -= m;                          // â‘§ å‡å°‘å¾…è¯»å–å­—èŠ‚æ•°
  }
  return 0;                          // â‘¨ å…¨éƒ¨è¯»å–æˆåŠŸ
}
```

**âš¡ å…³é”®ç‰¹æ€§**:
- ğŸ” **å¾ªç¯è¯»å–**: å¤„ç†è·¨è¶Šå¤šä¸ªç¼“å†²åŒºçš„è¯»å–
- ğŸ“Š **éƒ¨åˆ†è¯»å–**: æ”¯æŒéƒ¨åˆ†è¯»å–ï¼Œè¿”å›æœªè¯»å–çš„å­—èŠ‚æ•°
- ğŸš€ **é«˜æ•ˆå¤åˆ¶**: ä½¿ç”¨ `memcpy` è¿›è¡Œæ‰¹é‡æ•°æ®å¤åˆ¶

**ğŸ“– ä½¿ç”¨ç¤ºä¾‹**:

```c
// è¯»å–é¢„ç¼–è¯‘ä»£ç çš„å¤´éƒ¨
typedef struct {
    char signature[4];  // "\033Lua"
    char version;
    char format;
    // ...
} LuaHeader;

LuaHeader header;
ZIO *z = /* ... */;

// æ‰¹é‡è¯»å–ç»“æ„ä½“
size_t unread = luaZ_read(z, &header, sizeof(header));
if (unread != 0) {
    // è¯»å–å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸå
    error("incomplete header");
}

// éªŒè¯ç­¾å
if (memcmp(header.signature, "\033Lua", 4) != 0) {
    error("not a Lua bytecode file");
}
```

### 5. ç¼“å†²åŒºç©ºé—´åˆ†é…å‡½æ•° - luaZ_openspace

```c
char *luaZ_openspace (lua_State *L, Mbuffer *buff, size_t n)
```

**ğŸ’¡ åŠŸèƒ½**: ç¡®ä¿ç¼“å†²åŒºæœ‰è¶³å¤Ÿçš„ç©ºé—´

**ğŸ“¥ å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `L` | `lua_State*` | Lua çŠ¶æ€æœº |
| `buff` | `Mbuffer*` | ç›®æ ‡ç¼“å†²åŒº |
| `n` | `size_t` | éœ€è¦çš„æœ€å°ç©ºé—´ |

**â†©ï¸ è¿”å›å€¼**: æŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆ

**ğŸ” å®ç°é€»è¾‘**:
```c
char *luaZ_openspace (lua_State *L, Mbuffer *buff, size_t n) {
  if (n > buff->buffsize) {          // â‘  å½“å‰ç¼“å†²åŒºä¸å¤Ÿå¤§
    if (n < LUA_MINBUFFER)           // â‘¡ ç¡®ä¿æœ€å°ç¼“å†²åŒºå¤§å°
      n = LUA_MINBUFFER;
    luaZ_resizebuffer(L, buff, n);   // â‘¢ è°ƒæ•´ç¼“å†²åŒºå¤§å°
  }
  return buff->buffer;               // â‘£ è¿”å›ç¼“å†²åŒºæŒ‡é’ˆ
}
```

**ğŸ“Š ç¼“å†²åŒºæ‰©å±•ç­–ç•¥**:

```mermaid
graph TD
    A[è¯·æ±‚ n å­—èŠ‚] --> B{n > buffsize?}
    B -->|å¦| C[ç›´æ¥è¿”å›<br/>ç°æœ‰ç¼“å†²åŒº]
    B -->|æ˜¯| D{n < LUA_MINBUFFER?}
    D -->|æ˜¯| E[è®¾ç½® n = LUA_MINBUFFER]
    D -->|å¦| F[ä¿æŒ n]
    E --> G[è°ƒç”¨ luaZ_resizebuffer]
    F --> G
    G --> H[è¿”å›æ–°ç¼“å†²åŒºæŒ‡é’ˆ]
    
    style C fill:#c8e6c9,stroke:#388e3c
    style G fill:#fff3e0,stroke:#e65100
    style H fill:#c8e6c9,stroke:#388e3c
```

**âš¡ å…³é”®ç‰¹æ€§**:
- ğŸ“¦ **æŒ‰éœ€åˆ†é…**: åªåœ¨éœ€è¦æ—¶æ‰©å±•ç¼“å†²åŒº
- ğŸ“ **æœ€å°å¤§å°ä¿è¯**: ç¡®ä¿ç¼“å†²åŒºè‡³å°‘æœ‰æœ€å°å¤§å°
- ğŸ’¾ **å†…å­˜ç®¡ç†**: é€šè¿‡ Lua çš„å†…å­˜ç®¡ç†å™¨åˆ†é…å†…å­˜

**ğŸ“– ä½¿ç”¨ç¤ºä¾‹**:

```c
// åœ¨è¯æ³•åˆ†æå™¨ä¸­æ„å»º token
Mbuffer buff;
luaZ_initbuffer(L, &buff);

// è¯»å–ä¸€ä¸ªæ ‡è¯†ç¬¦
char *space = luaZ_openspace(L, &buff, 1);
int c = zgetc(z);
while (isalnum(c) || c == '_') {
    // ç¡®ä¿æœ‰ç©ºé—´
    if (buff.n >= buff.buffsize) {
        space = luaZ_openspace(L, &buff, buff.n + 1);
    }
    space[buff.n++] = c;
    c = zgetc(z);
}

// æ·»åŠ ç»ˆæ­¢ç¬¦
space = luaZ_openspace(L, &buff, buff.n + 1);
space[buff.n] = '\0';

printf("è¯†åˆ«å‡ºæ ‡è¯†ç¬¦: %s\n", luaZ_buffer(&buff));

// æ¸…ç†
luaZ_freebuffer(L, &buff);
```

## ğŸ”„ è¾“å…¥æµå·¥ä½œæœºåˆ¶

### 1. ç¼“å†²ç­–ç•¥

**ğŸ“Š æ•°æ®æµå‘å›¾**:

```mermaid
graph LR
    A[æ•°æ®æº<br/>æ–‡ä»¶/å­—ç¬¦ä¸²/ç½‘ç»œ] --> B[Readerå‡½æ•°<br/>ç”¨æˆ·å®šä¹‰]
    B --> C[å†…éƒ¨ç¼“å†²åŒº<br/>ZIOç»“æ„]
    C --> D[å­—ç¬¦è¯»å–<br/>zgetcå®]
    D --> E[è¯æ³•åˆ†æå™¨<br/>llex]
    
    style A fill:#e3f2fd,stroke:#1976d2
    style B fill:#fff3e0,stroke:#e65100
    style C fill:#c8e6c9,stroke:#388e3c
    style D fill:#f3e5f5,stroke:#4a148c
    style E fill:#ffebee,stroke:#c62828
```

**ğŸ”„ ç¼“å†²æµç¨‹è¯¦è§£**:

| é˜¶æ®µ | çŠ¶æ€ | æ“ä½œ |
|------|------|------|
| **1. åˆå§‹çŠ¶æ€** | `n=0, p=NULL` | ç¼“å†²åŒºä¸ºç©º |
| **2. é¦–æ¬¡è¯»å–** | è°ƒç”¨ `luaZ_fill` | ä»æ•°æ®æºå¡«å……ç¼“å†²åŒº |
| **3. å­—ç¬¦æ¶ˆè´¹** | é€šè¿‡ `zgetc` | å¿«é€Ÿè¯»å–ç¼“å†²åŒºä¸­çš„å­—ç¬¦ |
| **4. ç¼“å†²åŒºè€—å°½** | `n=0` æ—¶ | å†æ¬¡è°ƒç”¨ `luaZ_fill` é‡æ–°å¡«å…… |
| **5. æµç»“æŸ** | Reader è¿”å› NULL | è¿”å› EOZ æ ‡å¿— |

**ğŸ’¡ æ€§èƒ½ä¼˜åŒ–ç¤ºæ„**:

```
ä¸ä½¿ç”¨ç¼“å†² (æ¯æ¬¡éƒ½è°ƒç”¨ Reader):
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚ è¯»'p'â”‚ â”‚ è¯»'r'â”‚ â”‚ è¯»'i'â”‚ â”‚ è¯»'n'â”‚ â”‚ è¯»'t'â”‚  = 5æ¬¡ç³»ç»Ÿè°ƒç”¨
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨ç¼“å†² (æ‰¹é‡è¯»å–):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸€æ¬¡è¯»å– "print('hello')" å…¨éƒ¨  â”‚  = 1æ¬¡ç³»ç»Ÿè°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç„¶åä»å†…å­˜å¿«é€Ÿè®¿é—®å„å­—ç¬¦
```

### 2. è¯»å–å™¨æ¥å£

```c
typedef const char * (*lua_Reader) (lua_State *L, void *ud, size_t *sz);
```

**ğŸ“‹ è¯»å–å™¨èŒè´£**:
- âœ… ä»åº•å±‚æ•°æ®æºè¯»å–æ•°æ®
- âœ… è®¾ç½® `*sz` ä¸ºè¯»å–çš„å­—èŠ‚æ•°
- âœ… è¿”å›æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆï¼Œæˆ– NULL è¡¨ç¤ºç»“æŸ
- âœ… æ•°æ®åœ¨ä¸‹æ¬¡è°ƒç”¨å‰å¿…é¡»ä¿æŒæœ‰æ•ˆ

**ğŸ¨ å¸¸è§è¯»å–å™¨ç±»å‹ç¤ºä¾‹**:

```c
// 1ï¸âƒ£ æ–‡ä»¶è¯»å–å™¨
typedef struct {
    FILE *f;
    char buffer[BUFSIZ];
} FileReaderData;

const char* file_reader(lua_State *L, void *data, size_t *size) {
    FileReaderData *frd = (FileReaderData *)data;
    *size = fread(frd->buffer, 1, BUFSIZ, frd->f);
    return (*size > 0) ? frd->buffer : NULL;
}

// 2ï¸âƒ£ å­—ç¬¦ä¸²è¯»å–å™¨ï¼ˆä¸€æ¬¡æ€§ï¼‰
typedef struct {
    const char *str;
    size_t len;
} StringReaderData;

const char* string_reader(lua_State *L, void *data, size_t *size) {
    StringReaderData *srd = (StringReaderData *)data;
    if (srd->len == 0) return NULL;
    *size = srd->len;
    srd->len = 0;  // æ ‡è®°å·²è¯»
    return srd->str;
}

// 3ï¸âƒ£ åˆ†å—å­—ç¬¦ä¸²è¯»å–å™¨ï¼ˆæ”¯æŒå¤§å­—ç¬¦ä¸²ï¼‰
typedef struct {
    const char *str;
    size_t remaining;
    size_t chunk_size;
} ChunkStringReaderData;

const char* chunk_string_reader(lua_State *L, void *data, size_t *size) {
    ChunkStringReaderData *csrd = (ChunkStringReaderData *)data;
    if (csrd->remaining == 0) return NULL;
    
    *size = (csrd->remaining < csrd->chunk_size) 
            ? csrd->remaining 
            : csrd->chunk_size;
    
    const char *result = csrd->str;
    csrd->str += *size;
    csrd->remaining -= *size;
    return result;
}
```

**ğŸ”„ Reader è°ƒç”¨æ—¶åº**:

```mermaid
sequenceDiagram
    participant ZIO as ZIOç³»ç»Ÿ
    participant Reader as Readerå‡½æ•°
    participant Source as æ•°æ®æº
    
    Note over ZIO: ç¼“å†²åŒºç©º (n=0)
    ZIO->>Reader: è°ƒç”¨ reader(L, data, &size)
    Reader->>Source: è¯»å–æ•°æ®
    Source-->>Reader: è¿”å›æ•°æ®å—
    Reader-->>ZIO: è¿”å›æŒ‡é’ˆå’Œå¤§å°
    Note over ZIO: æ›´æ–° p, n
    
    loop æ¶ˆè´¹ç¼“å†²åŒºæ•°æ®
        Note over ZIO: zgetc() ä»ç¼“å†²åŒºè¯»å–
    end
    
    Note over ZIO: ç¼“å†²åŒºå†æ¬¡ä¸ºç©º
    ZIO->>Reader: å†æ¬¡è°ƒç”¨ reader
    Reader->>Source: ç»§ç»­è¯»å–
```

### 3. å­—ç¬¦è¯»å–ä¼˜åŒ–

#### zgetc å®çš„ä¼˜åŒ–ç­–ç•¥

```c
#define zgetc(z) (((z)->n--)>0 ? char2int(*(z)->p++) : luaZ_fill(z))
```

**âš¡ æ€§èƒ½åˆ†æ**:

```mermaid
pie title zgetc æ‰§è¡Œè·¯å¾„åˆ†å¸ƒ
    "å¿«é€Ÿè·¯å¾„ (ç¼“å†²åŒºæœ‰æ•°æ®)" : 95
    "æ…¢é€Ÿè·¯å¾„ (éœ€è¦å¡«å……)" : 5
```

**ğŸ” ä¼˜åŒ–ç‰¹ç‚¹å¯¹æ¯”**:

| ç‰¹æ€§ | å¿«é€Ÿè·¯å¾„ | æ…¢é€Ÿè·¯å¾„ |
|------|---------|---------|
| **è§¦å‘æ¡ä»¶** | `n > 0` | `n == 0` |
| **æ“ä½œ** | æŒ‡é’ˆé€’å¢ | è°ƒç”¨ `luaZ_fill` |
| **æ—¶é—´å¤æ‚åº¦** | O(1) - çº³ç§’çº§ | O(1) - å¾®ç§’çº§ |
| **CPUæŒ‡ä»¤æ•°** | ~3-5æ¡ | ~100+æ¡ |
| **ç³»ç»Ÿè°ƒç”¨** | âŒ æ—  | âœ… å¯èƒ½æœ‰ |
| **å‘ç”Ÿé¢‘ç‡** | ~95% | ~5% |

**ğŸ’¡ æ‰§è¡Œæµç¨‹å¯¹æ¯”**:

```
å¿«é€Ÿè·¯å¾„ (ç¼“å†²åŒºæœ‰æ•°æ®):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ n > 0       (1 æŒ‡ä»¤) â”‚
â”‚ 2. n--              (1 æŒ‡ä»¤) â”‚
â”‚ 3. è¯»å– *p          (1 æŒ‡ä»¤) â”‚
â”‚ 4. p++              (1 æŒ‡ä»¤) â”‚
â”‚ 5. char2intè½¬æ¢     (1 æŒ‡ä»¤) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»è®¡: ~5æ¡CPUæŒ‡ä»¤, <10çº³ç§’

æ…¢é€Ÿè·¯å¾„ (ç¼“å†²åŒºç©º):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ n > 0       (1 æŒ‡ä»¤) â”‚
â”‚ 2. è°ƒç”¨ luaZ_fill   (å‡½æ•°è°ƒç”¨)â”‚
â”‚    â”œâ”€ è§£é”                   â”‚
â”‚    â”œâ”€ è°ƒç”¨ Reader (I/O!)     â”‚
â”‚    â”œâ”€ åŠ é”                   â”‚
â”‚    â””â”€ æ›´æ–°çŠ¶æ€               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»è®¡: 100+æ¡æŒ‡ä»¤, å¯èƒ½>1å¾®ç§’
```

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å†…å­˜ç®¡ç†ä¼˜åŒ–

#### ç¼“å†²åŒºå¤ç”¨ç­–ç•¥

```c
#define luaZ_resetbuffer(buff) ((buff)->n = 0)
```

**ğŸ“Š å†…å­˜å¤ç”¨æ•ˆæœ**:

```mermaid
graph TD
    A[å¤„ç†Token 1] --> B[resetbuffer<br/>n=0, å†…å­˜ä¿ç•™]
    B --> C[å¤„ç†Token 2<br/>å¤ç”¨å†…å­˜]
    C --> D[resetbuffer<br/>n=0, å†…å­˜ä¿ç•™]
    D --> E[å¤„ç†Token 3<br/>ç»§ç»­å¤ç”¨]
    E --> F[å¤„ç†å®Œæˆ<br/>freebuffer]
    
    style A fill:#e3f2fd,stroke:#1976d2
    style C fill:#e3f2fd,stroke:#1976d2
    style E fill:#e3f2fd,stroke:#1976d2
    style B fill:#c8e6c9,stroke:#388e3c
    style D fill:#c8e6c9,stroke:#388e3c
    style F fill:#ffcdd2,stroke:#c62828
```

**âœ… ä¼˜ç‚¹**:
- ğŸš€ **é¿å…é‡åˆ†é…**: é‡ç½®é•¿åº¦è€Œä¸é‡Šæ”¾å†…å­˜
- ğŸ’¾ **å†…å­˜å¤ç”¨**: åç»­æ“ä½œå¯ä»¥å¤ç”¨å·²åˆ†é…çš„å†…å­˜
- ğŸ“‰ **å‡å°‘ç¢ç‰‡**: å‡å°‘é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾

**ğŸ“– å®è·µå¯¹æ¯”**:

```c
// âŒ ä½æ•ˆæ–¹å¼ - æ¯æ¬¡éƒ½é‡æ–°åˆ†é…
for (int i = 0; i < 1000; i++) {
    Mbuffer buff;
    luaZ_initbuffer(L, &buff);
    // ä½¿ç”¨ç¼“å†²åŒº...
    luaZ_freebuffer(L, &buff);  // é‡Šæ”¾
}
// 1000æ¬¡åˆ†é…å’Œé‡Šæ”¾ï¼Œæ€§èƒ½å·®

// âœ… é«˜æ•ˆæ–¹å¼ - å¤ç”¨ç¼“å†²åŒº
Mbuffer buff;
luaZ_initbuffer(L, &buff);
for (int i = 0; i < 1000; i++) {
    luaZ_resetbuffer(&buff);  // åªé‡ç½®ï¼Œä¸é‡Šæ”¾
    // ä½¿ç”¨ç¼“å†²åŒº...
}
luaZ_freebuffer(L, &buff);  // æœ€åé‡Šæ”¾ä¸€æ¬¡
// åªæœ‰1æ¬¡åˆ†é…å’Œé‡Šæ”¾ï¼Œæ€§èƒ½ä¼˜ç§€
```

#### æœ€å°ç¼“å†²åŒºå¤§å°ç­–ç•¥

```c
if (n < LUA_MINBUFFER) n = LUA_MINBUFFER;
```

**ğŸ“Š å¢é•¿ç­–ç•¥å¯¹æ¯”**:

```mermaid
graph LR
    A[è¯·æ±‚1å­—èŠ‚] --> B{åº”ç”¨ç­–ç•¥}
    B --> C[åˆ†é…LUA_MINBUFFER<br/>ä¾‹å¦‚32å­—èŠ‚]
    C --> D[åç»­31æ¬¡è¯·æ±‚<br/>æ— éœ€åˆ†é…]
    
    style A fill:#fff3e0,stroke:#e65100
    style C fill:#c8e6c9,stroke:#388e3c
    style D fill:#e3f2fd,stroke:#1976d2
```

**ğŸ’¡ å¥½å¤„**:
- ğŸ“‰ **å‡å°‘å°åˆ†é…**: é¿å…è¿‡å°çš„å†…å­˜åˆ†é…
- âš¡ **æé«˜æ•ˆç‡**: å‡å°‘é‡åˆ†é…çš„é¢‘ç‡
- âš–ï¸ **å¹³è¡¡ç­–ç•¥**: åœ¨å†…å­˜ä½¿ç”¨å’Œæ€§èƒ½é—´å¹³è¡¡

### 2. è¯»å–ä¼˜åŒ–

#### æ‰¹é‡è¯»å–æ€§èƒ½

**ğŸ“Š æ€§èƒ½å¯¹æ¯”æµ‹è¯•**:

```
æµ‹è¯•: è¯»å–10KBæ•°æ®

é€å­—ç¬¦è¯»å– (zgetc):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨æ¬¡æ•°: 10,240æ¬¡      â”‚
â”‚ æ—¶é—´: ~100å¾®ç§’          â”‚
â”‚ ç³»ç»Ÿè°ƒç”¨: ~10æ¬¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰¹é‡è¯»å– (luaZ_read):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨æ¬¡æ•°: 1æ¬¡           â”‚
â”‚ æ—¶é—´: ~20å¾®ç§’           â”‚
â”‚ ç³»ç»Ÿè°ƒç”¨: ~1æ¬¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€§èƒ½æå‡: 5å€! ğŸš€
```

**ğŸ”„ ä¼˜åŒ–åŸç†**:

```mermaid
graph TD
    A[æ‰¹é‡è¯»å–] --> B[å‡å°‘å‡½æ•°è°ƒç”¨]
    A --> C[å‡å°‘ç³»ç»Ÿè°ƒç”¨]
    A --> D[æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨]
    B --> E[æ€§èƒ½æå‡]
    C --> E
    D --> E
    
    style A fill:#e3f2fd,stroke:#1976d2
    style E fill:#c8e6c9,stroke:#388e3c
```

#### å‰ç»ä¼˜åŒ–

**ğŸ’¡ è®¾è®¡ä¼˜åŠ¿**:

```c
// å‰ç»ä¸è§¦å‘é¢å¤–I/O
int next = luaZ_lookahead(z);  // åªæŸ¥çœ‹
if (next == '.') {
    zgetc(z);  // å†³å®šåå†æ¶ˆè´¹
}
```

**âš¡ æ€§èƒ½ç‰¹ç‚¹**:
- ğŸ¯ **éæ¶ˆè´¹æ€§**: å‰ç»ä¸æ”¹å˜æµçŠ¶æ€
- ğŸ“¦ **æ™ºèƒ½ç¼“å†²**: è‡ªåŠ¨å¤„ç†ç¼“å†²åŒºå¡«å……
- ğŸš€ **è¯æ³•åˆ†ææ”¯æŒ**: ä¸ºè¯æ³•åˆ†æå™¨æä¾›é«˜æ•ˆå‰ç»

### 3. çº¿ç¨‹å®‰å…¨

#### é”ç®¡ç†æœºåˆ¶

```c
lua_unlock(L);                    // é‡Šæ”¾é”
buff = z->reader(L, z->data, &size);  // I/Oæ“ä½œ
lua_lock(L);                      // é‡æ–°è·å–é”
```

**ğŸ”’ é”ç­–ç•¥å¯è§†åŒ–**:

```mermaid
sequenceDiagram
    participant Thread as å½“å‰çº¿ç¨‹
    participant Lock as Luaé”
    participant IO as I/Oæ“ä½œ
    
    Thread->>Lock: lua_lock(æŒæœ‰)
    Note over Thread: æ­£å¸¸å¤„ç†...
    Thread->>Lock: lua_unlock(é‡Šæ”¾)
    Note over Thread,IO: å…è®¸å…¶ä»–çº¿ç¨‹å·¥ä½œ
    Thread->>IO: æ‰§è¡Œè€—æ—¶I/O
    IO-->>Thread: I/Oå®Œæˆ
    Thread->>Lock: lua_lock(é‡æ–°è·å–)
    Note over Thread: ç»§ç»­å¤„ç†...
    
    style IO fill:#fff3e0,stroke:#e65100
```

**âœ… ä¼˜ç‚¹**:
- â±ï¸ **æœ€å°é”å®š**: åªåœ¨å¿…è¦æ—¶æŒæœ‰é”
- ğŸ”“ **ç”¨æˆ·å‡½æ•°è°ƒç”¨**: è°ƒç”¨ç”¨æˆ·å‡½æ•°æ—¶é‡Šæ”¾é”
- ğŸ›¡ï¸ **çŠ¶æ€ä¿æŠ¤**: ä¿æŠ¤ Lua çŠ¶æ€çš„ä¸€è‡´æ€§

## ğŸ¯ ä½¿ç”¨åœºæ™¯åˆ†æ

### 1. è¯æ³•åˆ†æ

**ğŸ“– å…¸å‹ä»£ç æ¨¡å¼**:

```c
// è¯æ³•åˆ†æå™¨ä¸­çš„å…¸å‹ä½¿ç”¨
int c = zgetc(ls->z);             // è¯»å–å½“å‰å­—ç¬¦
int next = luaZ_lookahead(ls->z); // å‰ç»ä¸‹ä¸€ä¸ªå­—ç¬¦

// ç¤ºä¾‹: è§£ææ•°å­—å­—é¢é‡
static void read_number(LexState *ls) {
    int c = zgetc(ls->z);
    
    // è¯»å–æ•°å­—ä¸»ä½“
    while (isdigit(c = luaZ_lookahead(ls->z))) {
        save_and_next(ls);  // ä¿å­˜å¹¶è¯»å–
    }
    
    // æ£€æŸ¥å°æ•°ç‚¹
    if (c == '.') {
        save_and_next(ls);
        while (isdigit(c = luaZ_lookahead(ls->z))) {
            save_and_next(ls);
        }
    }
    
    // æ£€æŸ¥æŒ‡æ•°éƒ¨åˆ†
    if (c == 'e' || c == 'E') {
        save_and_next(ls);
        c = luaZ_lookahead(ls->z);
        if (c == '+' || c == '-') {
            save_and_next(ls);
        }
        while (isdigit(c = luaZ_lookahead(ls->z))) {
            save_and_next(ls);
        }
    }
}
```

**ğŸ”„ å·¥ä½œæµç¨‹**:

```mermaid
stateDiagram-v2
    [*] --> è¯»å–å­—ç¬¦
    è¯»å–å­—ç¬¦ --> å‰ç»åˆ¤æ–­: zgetc()
    å‰ç»åˆ¤æ–­ --> åˆ¤æ–­ç±»å‹: lookahead()
    åˆ¤æ–­ç±»å‹ --> æ•°å­—: isdigit()
    åˆ¤æ–­ç±»å‹ --> å­—æ¯: isalpha()
    åˆ¤æ–­ç±»å‹ --> ç¬¦å·: å…¶ä»–
    æ•°å­— --> è§£ææ•°å­—
    å­—æ¯ --> è§£ææ ‡è¯†ç¬¦
    ç¬¦å· --> è§£ææ“ä½œç¬¦
    è§£ææ•°å­— --> [*]
    è§£ææ ‡è¯†ç¬¦ --> [*]
    è§£ææ“ä½œç¬¦ --> [*]
```

**âš¡ ç‰¹ç‚¹**:
- ğŸ”¤ **å­—ç¬¦çº§è¯»å–**: é€å­—ç¬¦å¤„ç†æºä»£ç 
- ğŸ‘€ **å‰ç»éœ€æ±‚**: éœ€è¦æŸ¥çœ‹ä¸‹ä¸€ä¸ªå­—ç¬¦æ¥å†³å®štokenç±»å‹
- ğŸ” **é«˜é¢‘è°ƒç”¨**: è¯æ³•åˆ†æè¿‡ç¨‹ä¸­é¢‘ç¹è°ƒç”¨

### 2. è§£æå™¨

**ğŸ“– è¯»å–é¢„ç¼–è¯‘ä»£ç ç¤ºä¾‹**:

```c
// è§£æå™¨ä¸­è¯»å–é¢„ç¼–è¯‘ä»£ç 
static void LoadHeader(LoadState *S) {
    char h[LUAC_HEADERSIZE];
    char s[LUAC_HEADERSIZE];
    
    // æ‰¹é‡è¯»å–å¤´éƒ¨
    luaZ_read(S->Z, h, LUAC_HEADERSIZE);
    
    // éªŒè¯ç­¾å
    if (memcmp(h, LUA_SIGNATURE, sizeof(LUA_SIGNATURE)-1) != 0) {
        error(S, "not a");
    }
    
    // éªŒè¯ç‰ˆæœ¬
    if (h[4] != LUAC_VERSION) {
        error(S, "version mismatch");
    }
}

static void LoadFunction(LoadState *S, Proto *f) {
    // è¯»å–å‡½æ•°å
    f->source = LoadString(S);
    
    // è¯»å–è¡Œå·ä¿¡æ¯
    f->linedefined = LoadInt(S);
    f->lastlinedefined = LoadInt(S);
    
    // è¯»å–å‚æ•°ä¿¡æ¯
    f->numparams = LoadByte(S);
    f->is_vararg = LoadByte(S);
    f->maxstacksize = LoadByte(S);
    
    // è¯»å–æŒ‡ä»¤æ•°ç»„
    int n = LoadInt(S);
    f->code = luaM_newvector(S->L, n, Instruction);
    f->sizecode = n;
    LoadVector(S, f->code, n, sizeof(Instruction));
}
```

**ğŸ”„ å­—èŠ‚ç åŠ è½½æµç¨‹**:

```mermaid
flowchart TD
    A[å¼€å§‹åŠ è½½] --> B[è¯»å–å¤´éƒ¨<br/>LoadHeader]
    B --> C{ç­¾åéªŒè¯}
    C -->|å¤±è´¥| D[æŠ›å‡ºé”™è¯¯]
    C -->|æˆåŠŸ| E[è¯»å–å‡½æ•°<br/>LoadFunction]
    E --> F[è¯»å–å¸¸é‡è¡¨]
    F --> G[è¯»å–ä¸Šå€¼ä¿¡æ¯]
    G --> H[è¯»å–è°ƒè¯•ä¿¡æ¯]
    H --> I[æ„å»ºProtoå¯¹è±¡]
    I --> J[åŠ è½½å®Œæˆ]
    
    style A fill:#e3f2fd,stroke:#1976d2
    style D fill:#ffcdd2,stroke:#c62828
    style J fill:#c8e6c9,stroke:#388e3c
```

**âš¡ ç‰¹ç‚¹**:
- ğŸ“¦ **å—è¯»å–**: è¯»å–å›ºå®šå¤§å°çš„æ•°æ®å—
- ğŸ”¢ **äºŒè¿›åˆ¶æ•°æ®**: å¤„ç†é¢„ç¼–è¯‘çš„å­—èŠ‚ç 
- âœ… **é”™è¯¯æ£€æŸ¥**: æ£€æŸ¥è¯»å–æ˜¯å¦å®Œæ•´

### 3. å­—ç¬¦ä¸²å¤„ç†

**ğŸ“– åŠ¨æ€å­—ç¬¦ä¸²æ„å»ºç¤ºä¾‹**:

```c
// åŠ¨æ€æ„å»ºå­—ç¬¦ä¸²
static TString* read_long_string(LexState *ls) {
    Mbuffer *buff = ls->buff;
    int sep = skip_sep(ls);  // è·³è¿‡åˆ†éš”ç¬¦
    
    luaZ_resetbuffer(buff);  // é‡ç½®ç¼“å†²åŒº
    
    for (;;) {
        int c = zgetc(ls->z);
        
        switch (c) {
            case EOZ:
                error(ls, "unfinished long string");
                break;
                
            case ']': {
                if (skip_sep(ls) == sep) {
                    // æ‰¾åˆ°ç»“æŸæ ‡è®°
                    save(ls, '\0');  // æ·»åŠ ç»ˆæ­¢ç¬¦
                    return luaX_newstring(ls, 
                        luaZ_buffer(buff) + (2 + sep),
                        luaZ_bufflen(buff) - 2*(2 + sep));
                }
                break;
            }
            
            default:
                save(ls, c);  // ä¿å­˜å­—ç¬¦
        }
    }
}

static void save(LexState *ls, int c) {
    Mbuffer *b = ls->buff;
    
    // ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
    if (b->n + 1 > b->buffsize) {
        size_t newsize = b->buffsize * 2;
        if (newsize < b->n + 1) newsize = b->n + 1;
        luaZ_openspace(ls->L, b, newsize);
    }
    
    // ä¿å­˜å­—ç¬¦
    b->buffer[b->n++] = cast(char, c);
}
```

**ğŸ“Š ç¼“å†²åŒºå¢é•¿ç¤ºä¾‹**:

```
å¤„ç†é•¿å­—ç¬¦ä¸² "ä¸€æ®µå¾ˆé•¿çš„æ–‡æœ¬..."

åˆå§‹:  buffsize=32, n=0
      [                                ]

å†™å…¥32å­—ç¬¦å:
      [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA]
      buffsize=32, n=32 (å·²æ»¡!)

è‡ªåŠ¨æ‰©å±•:
      [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA                                ]
      buffsize=64, n=32

ç»§ç»­å†™å…¥...
      [AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBBB      ]
      buffsize=64, n=54
```

**âš¡ ç‰¹ç‚¹**:
- ğŸ“ˆ **åŠ¨æ€å¢é•¿**: æ ¹æ®éœ€è¦æ‰©å±•ç¼“å†²åŒº
- ğŸ’¾ **å†…å­˜æ•ˆç‡**: é¿å…é¢‘ç¹çš„é‡åˆ†é…
- ğŸ”¤ **å­—ç¬¦ä¸²æ„å»º**: ç”¨äºæ„å»ºåŠ¨æ€å­—ç¬¦ä¸²

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. æµç»“æŸæ£€æµ‹

```c
if (buff == NULL || size == 0) return EOZ;
```

**ğŸ” æ£€æµ‹ç­–ç•¥**:

| æƒ…å†µ | Readerè¿”å› | ZIOå¤„ç† | ç»“æœ |
|------|-----------|---------|------|
| **æ­£å¸¸æ•°æ®** | æœ‰æ•ˆæŒ‡é’ˆ + size>0 | æ›´æ–°ç¼“å†²åŒº | âœ… ç»§ç»­è¯»å– |
| **æµç»“æŸ** | NULL | è¿”å›EOZ | âš ï¸ åœæ­¢è¯»å– |
| **ç©ºæ•°æ®** | æŒ‡é’ˆ + size=0 | è¿”å›EOZ | âš ï¸ åœæ­¢è¯»å– |
| **Readeré”™è¯¯** | NULL | è¿”å›EOZ | âŒ é”™è¯¯ä¼ æ’­ |

**ğŸ”„ é”™è¯¯ä¼ æ’­æµç¨‹**:

```mermaid
flowchart TD
    A[Readerå‡½æ•°] --> B{è¿”å›å€¼?}
    B -->|NULL| C[luaZ_fillè¿”å›EOZ]
    B -->|size=0| C
    B -->|æœ‰æ•ˆæ•°æ®| D[æ­£å¸¸å¤„ç†]
    C --> E[zgetcè¿”å›EOZ]
    E --> F[ä¸Šå±‚æ£€æŸ¥EOZ]
    F --> G[æŠ¥å‘Šé”™è¯¯æˆ–ç»“æŸ]
    
    style C fill:#ffcdd2,stroke:#c62828
    style E fill:#ffcdd2,stroke:#c62828
    style G fill:#ffcdd2,stroke:#c62828
    style D fill:#c8e6c9,stroke:#388e3c
```

### 2. å†…å­˜åˆ†é…é”™è¯¯

```c
luaM_reallocvector(L, (buff)->buffer, (buff)->buffsize, size, char)
```

**ğŸ›¡ï¸ å¤„ç†ç­–ç•¥**:

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ä»£ç 
    participant ZIO as ZIOç³»ç»Ÿ
    participant Mem as å†…å­˜ç®¡ç†å™¨
    participant Lua as Luaå¼‚å¸¸ç³»ç»Ÿ
    
    App->>ZIO: luaZ_openspace(1000)
    ZIO->>Mem: luaM_reallocvector
    
    alt å†…å­˜å……è¶³
        Mem-->>ZIO: è¿”å›æŒ‡é’ˆ
        ZIO-->>App: è¿”å›ç¼“å†²åŒº
    else å†…å­˜ä¸è¶³
        Mem->>Lua: luaM_toobig()
        Lua->>App: longjmp (å¼‚å¸¸)
        Note over App: ç¨‹åºè·³è½¬åˆ°<br/>é”™è¯¯å¤„ç†
    end
    
    style Mem fill:#fff3e0,stroke:#e65100
    style Lua fill:#ffcdd2,stroke:#c62828
```

**âœ… ä¼˜ç‚¹**:
- ğŸ”„ **Lua å†…å­˜ç®¡ç†**: ä½¿ç”¨ Lua çš„å†…å­˜ç®¡ç†å™¨
- ğŸš¨ **å¼‚å¸¸ä¼ æ’­**: å†…å­˜é”™è¯¯ä¼šé€šè¿‡ Lua çš„å¼‚å¸¸æœºåˆ¶ä¼ æ’­
- ğŸ›¡ï¸ **çŠ¶æ€ä¸€è‡´æ€§**: ç¡®ä¿é”™è¯¯åçŠ¶æ€ä»ç„¶ä¸€è‡´

### 3. è¯»å–å™¨é”™è¯¯

```c
lua_unlock(L);
buff = z->reader(L, z->data, &size);
lua_lock(L);
```

**ğŸ“‹ é”™è¯¯å¤„ç†èŒè´£**:

| å±‚æ¬¡ | èŒè´£ | é”™è¯¯å¤„ç† |
|------|------|---------|
| **Readerå‡½æ•°** | å¤„ç†åº•å±‚I/Oé”™è¯¯ | è¿”å›NULLè¡¨ç¤ºé”™è¯¯ |
| **ZIOç³»ç»Ÿ** | æ£€æµ‹Readeré”™è¯¯ | è¿”å›EOZæ ‡å¿— |
| **è¯æ³•åˆ†æå™¨** | è§£é‡ŠEOZè¯­ä¹‰ | å†³å®šæ˜¯æ­£å¸¸ç»“æŸè¿˜æ˜¯é”™è¯¯ |
| **è¯­æ³•åˆ†æå™¨** | æŠ¥å‘Šè¯­æ³•é”™è¯¯ | ç”Ÿæˆç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯ |

**ğŸ”„ é”™è¯¯æ¢å¤ç¤ºä¾‹**:

```c
// Readerå‡½æ•°ä¸­çš„é”™è¯¯å¤„ç†
const char* file_reader(lua_State *L, void *data, size_t *size) {
    FILE *f = (FILE *)data;
    static char buffer[BUFSIZ];
    
    if (feof(f)) {
        return NULL;  // æ­£å¸¸ç»“æŸ
    }
    
    *size = fread(buffer, 1, BUFSIZ, f);
    
    if (*size == 0) {
        if (ferror(f)) {
            // I/Oé”™è¯¯ - å¯ä»¥é€‰æ‹©ï¼š
            // 1. è¿”å›NULLè®©ZIOå¤„ç†
            // 2. é€šè¿‡lua_erroræŠ›å‡ºé”™è¯¯
            luaL_error(L, "error reading file: %s", strerror(errno));
        }
        return NULL;  // EOF
    }
    
    return buffer;
}
```

## ğŸ¨ è®¾è®¡æ¨¡å¼åˆ†æ

### 1. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

**ğŸ“‹ æ¨¡å¼ç»“æ„**:

```mermaid
classDiagram
    class ZIO {
        -lua_Reader reader
        -void* data
        +luaZ_init()
        +zgetc()
    }
    
    class lua_Reader {
        <<interface>>
        +read()
    }
    
    class FileReader {
        +read()
    }
    
    class StringReader {
        +read()
    }
    
    class NetworkReader {
        +read()
    }
    
    ZIO --> lua_Reader
    lua_Reader <|.. FileReader
    lua_Reader <|.. StringReader
    lua_Reader <|.. NetworkReader
    
    style ZIO fill:#e3f2fd,stroke:#1976d2
    style lua_Reader fill:#fff3e0,stroke:#e65100
```

**ğŸ’¡ ä¼˜ç‚¹**:
- ğŸ”Œ **æŠ½è±¡æ¥å£**: `lua_Reader` å®šä¹‰ç»Ÿä¸€æ¥å£
- ğŸ¯ **å…·ä½“ç­–ç•¥**: ä¸åŒçš„è¯»å–å™¨å®ç°ä¸åŒçš„è¯»å–ç­–ç•¥
- âš™ï¸ **è¿è¡Œæ—¶é€‰æ‹©**: åœ¨åˆå§‹åŒ–æ—¶é€‰æ‹©å…·ä½“çš„è¯»å–ç­–ç•¥

### 2. ç¼“å†²æ¨¡å¼ (Buffer Pattern)

**ğŸ”„ æ¨¡å¼ç»“æ„**:

```mermaid
graph TD
    A[ä¸Šå±‚åº”ç”¨<br/>è¯æ³•åˆ†æå™¨] --> B[ç¼“å†²å±‚<br/>ZIO]
    B --> C[åº•å±‚æ•°æ®æº<br/>æ–‡ä»¶/ç½‘ç»œ]
    
    B1[å¿«é€Ÿ: ä»ç¼“å†²åŒºè¯»å–] -.-> B
    B2[æ…¢é€Ÿ: è°ƒç”¨Readerå¡«å……] -.-> B
    
    style A fill:#f3e5f5,stroke:#4a148c
    style B fill:#e1f5ff,stroke:#01579b
    style C fill:#fff3e0,stroke:#e65100
```

**ğŸ’¡ ç‰¹ç‚¹**:
- ğŸ“¦ **ç¼“å†²å±‚**: åœ¨åº•å±‚æ•°æ®æºå’Œä¸Šå±‚åº”ç”¨é—´æä¾›ç¼“å†²
- ğŸ” **é€æ˜æ€§**: ä¸Šå±‚ä»£ç æ— éœ€å…³å¿ƒç¼“å†²ç»†èŠ‚
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘åº•å±‚è¯»å–è°ƒç”¨çš„é¢‘ç‡

### 3. é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

**ğŸ”„ æ¨¡å¼ç»“æ„**:

```mermaid
graph LR
    A[ç»Ÿä¸€çš„ZIOæ¥å£] --> B[æ–‡ä»¶é€‚é…å™¨]
    A --> C[å­—ç¬¦ä¸²é€‚é…å™¨]
    A --> D[ç½‘ç»œé€‚é…å™¨]
    A --> E[è‡ªå®šä¹‰é€‚é…å™¨]
    
    B --> B1[FILE*]
    C --> C1[char*]
    D --> D1[socket]
    E --> E1[ç”¨æˆ·å®šä¹‰]
    
    style A fill:#e3f2fd,stroke:#1976d2
    style B fill:#c8e6c9,stroke:#388e3c
    style C fill:#c8e6c9,stroke:#388e3c
    style D fill:#c8e6c9,stroke:#388e3c
    style E fill:#c8e6c9,stroke:#388e3c
```

**ğŸ’¡ ä¼˜ç‚¹**:
- ğŸ¯ **å¤šç§æ•°æ®æº**: æ–‡ä»¶ã€å­—ç¬¦ä¸²ã€ç½‘ç»œç­‰
- ğŸ”„ **ç»Ÿä¸€è®¿é—®**: é€šè¿‡ç›¸åŒçš„æ¥å£è®¿é—®ä¸åŒæ•°æ®æº
- ğŸš€ **ç®€åŒ–ä½¿ç”¨**: ä¸Šå±‚ä»£ç æ— éœ€å…³å¿ƒæ•°æ®æºç±»å‹

## ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„äº¤äº’

### æ¨¡å—ä¾èµ–å…³ç³»å›¾

```mermaid
graph TB
    subgraph "è¯æ³•è§£æå±‚"
        A[llex.c è¯æ³•åˆ†æå™¨]
        B[lparser.c è¯­æ³•åˆ†æå™¨]
    end
    
    subgraph "è¾“å…¥æµå±‚"
        C[lzio.c è¾“å…¥æµç³»ç»Ÿ]
    end
    
    subgraph "æ”¯æŒå±‚"
        D[lmem.c å†…å­˜ç®¡ç†]
        E[lstate.c çŠ¶æ€ç®¡ç†]
    end
    
    A --> C
    B --> C
    C --> D
    C --> E
    
    style C fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    style A fill:#f3e5f5,stroke:#4a148c
    style B fill:#f3e5f5,stroke:#4a148c
    style D fill:#fff3e0,stroke:#e65100
    style E fill:#fff3e0,stroke:#e65100
```

### 1. è¯æ³•åˆ†æå™¨ (llex.c)

```c
// è¯æ³•åˆ†æå™¨ä½¿ç”¨ ZIO è¯»å–æºä»£ç 
struct LexState {
  ZIO *z;           // è¾“å…¥æµ
  Mbuffer *buff;    // ç¼“å†²åŒº
  // ...
};
```

**ğŸ”„ äº¤äº’æ–¹å¼**:
- ğŸ“– **å­—ç¬¦è¯»å–**: ä½¿ç”¨ `zgetc` è¯»å–å­—ç¬¦
- ğŸ‘€ **å‰ç»**: ä½¿ç”¨ `luaZ_lookahead` è¿›è¡Œå‰ç»
- ğŸ“¦ **ç¼“å†²åŒº**: ä½¿ç”¨ `Mbuffer` æ„å»ºtoken

### 2. è§£æå™¨ (lparser.c)

```c
// è§£æå™¨é€šè¿‡ ZIO è¯»å–é¢„ç¼–è¯‘ä»£ç 
Proto *luaU_undump(lua_State *L, ZIO *Z, Mbuffer *buff, const char *name);
```

**ğŸ”„ äº¤äº’æ–¹å¼**:
- ğŸ“¦ **å—è¯»å–**: ä½¿ç”¨ `luaZ_read` è¯»å–æ•°æ®å—
- ğŸ”¢ **äºŒè¿›åˆ¶æ•°æ®**: è¯»å–é¢„ç¼–è¯‘çš„å­—èŠ‚ç 
- âŒ **é”™è¯¯å¤„ç†**: å¤„ç†è¯»å–é”™è¯¯

### 3. å†…å­˜ç®¡ç†å™¨ (lmem.c)

```c
// ç¼“å†²åŒºç®¡ç†ä½¿ç”¨ Lua çš„å†…å­˜ç®¡ç†
luaM_reallocvector(L, (buff)->buffer, (buff)->buffsize, size, char)
```

**ğŸ”„ äº¤äº’æ–¹å¼**:
- ğŸ’¾ **å†…å­˜åˆ†é…**: ä½¿ç”¨ `luaM_reallocvector` åˆ†é…å†…å­˜
- âŒ **é”™è¯¯å¤„ç†**: å†…å­˜é”™è¯¯é€šè¿‡å¼‚å¸¸æœºåˆ¶å¤„ç†
- ğŸ—‘ï¸ **åƒåœ¾å›æ”¶**: ä¸ Lua çš„åƒåœ¾å›æ”¶å™¨åä½œ

## ğŸ“ æ€»ç»“

`lzio.h` å’Œ `lzio.c` å®ç°äº† Lua çš„é€šç”¨è¾“å…¥æµç³»ç»Ÿï¼Œæ˜¯ Lua ç¼–è¯‘å™¨å‰ç«¯çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚

### ğŸ¯ æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | æè¿° | ä¼˜åŠ¿ |
|------|------|------|
| **ğŸ”„ ç»Ÿä¸€æ¥å£** | æ”¯æŒå¤šç§æ•°æ®æºçš„ç»Ÿä¸€è®¿é—® | ç®€åŒ–ä¸Šå±‚ä»£ç ï¼Œæé«˜å¯æ‰©å±•æ€§ |
| **âš¡ é«˜æ•ˆç¼“å†²** | å‡å°‘åº•å±‚è¯»å–è°ƒç”¨ï¼Œæé«˜æ€§èƒ½ | æ€§èƒ½æå‡5-10å€ |
| **ğŸ’¾ çµæ´»å†…å­˜** | åŠ¨æ€ç¼“å†²åŒºç®¡ç†å’Œå†…å­˜å¤ç”¨ | å‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜æ•ˆç‡ |
| **âœ… å®Œå–„é”™è¯¯å¤„ç†** | ä¼˜é›…å¤„ç†å„ç§é”™è¯¯æƒ…å†µ | æé«˜ç³»ç»Ÿç¨³å®šæ€§ |
| **ğŸ”’ çº¿ç¨‹å®‰å…¨** | é€‚å½“çš„é”ç®¡ç†ä¿è¯çº¿ç¨‹å®‰å…¨ | æ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒ |
| **ğŸ¨ æ¨¡å—åŒ–è®¾è®¡** | æ¸…æ™°çš„æ¥å£å’ŒèŒè´£åˆ†ç¦» | æ˜“äºç»´æŠ¤å’Œæ‰©å±• |

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

```mermaid
graph TB
    subgraph "ä½¿ç”¨ZIOç¼“å†²ç³»ç»Ÿ"
        A1[è¯»å–10KBæºç ] --> A2[~100å¾®ç§’]
        A2 --> A3[ç³»ç»Ÿè°ƒç”¨: ~10æ¬¡]
    end
    
    subgraph "ä¸ä½¿ç”¨ç¼“å†²"
        B1[è¯»å–10KBæºç ] --> B2[~1000å¾®ç§’]
        B2 --> B3[ç³»ç»Ÿè°ƒç”¨: ~10000æ¬¡]
    end
    
    A3 -.æ€§èƒ½æå‡10å€.-> B3
    
    style A2 fill:#c8e6c9,stroke:#388e3c
    style B2 fill:#ffcdd2,stroke:#c62828
```

### ğŸ”‘ å…³é”®è®¾è®¡åŸåˆ™

1. **ğŸ“¦ åˆ†å±‚æŠ½è±¡**
   - åº•å±‚: Readerå‡½æ•°é€‚é…ä¸åŒæ•°æ®æº
   - ä¸­å±‚: ZIOæä¾›ç»Ÿä¸€çš„æµæ¥å£
   - ä¸Šå±‚: è¯æ³•/è¯­æ³•åˆ†æå™¨ä½¿ç”¨æµæ¥å£

2. **âš¡ æ€§èƒ½ä¼˜å…ˆ**
   - ç¼“å†²æœºåˆ¶å‡å°‘I/Oæ¬¡æ•°
   - å®å®ç°çš„å¿«é€Ÿè·¯å¾„
   - å†…å­˜å¤ç”¨å‡å°‘åˆ†é…

3. **ğŸ›¡ï¸ å®‰å…¨å¯é **
   - å®Œå–„çš„é”™è¯¯æ£€æµ‹
   - è¾¹ç•Œæ£€æŸ¥
   - çº¿ç¨‹å®‰å…¨æœºåˆ¶

4. **ğŸ”Œ çµæ´»æ‰©å±•**
   - é€šè¿‡Readerå‡½æ•°æ”¯æŒä»»æ„æ•°æ®æº
   - åŠ¨æ€ç¼“å†²åŒºé€‚åº”ä¸åŒéœ€æ±‚
   - æ¸…æ™°çš„æ¥å£ä¾¿äºæ‰©å±•

### ğŸ“ å­¦ä¹ è¦ç‚¹

å¯¹äºå­¦ä¹  Lua æºç çš„å¼€å‘è€…ï¼ŒZIO ç³»ç»Ÿæä¾›äº†ä»¥ä¸‹å­¦ä¹ ä»·å€¼ï¼š

1. **è®¾è®¡æ¨¡å¼å®è·µ**
   - ç­–ç•¥æ¨¡å¼: Readerå‡½æ•°æŒ‡é’ˆ
   - ç¼“å†²æ¨¡å¼: ZIOç¼“å†²å±‚
   - é€‚é…å™¨æ¨¡å¼: ç»Ÿä¸€ä¸åŒæ•°æ®æº

2. **æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
   - ç¼“å†²I/Oå‡å°‘ç³»ç»Ÿè°ƒç”¨
   - å®å®ç°çš„å†…è”ä¼˜åŒ–
   - å†…å­˜å¤ç”¨ç­–ç•¥

3. **é”™è¯¯å¤„ç†æœºåˆ¶**
   - åˆ†å±‚é”™è¯¯ä¼ æ’­
   - å¼‚å¸¸å®‰å…¨è®¾è®¡
   - èµ„æºç®¡ç†

4. **Cè¯­è¨€ç¼–ç¨‹å®è·µ**
   - å‡½æ•°æŒ‡é’ˆçš„çµæ´»è¿ç”¨
   - ç»“æ„ä½“å°è£…
   - å®çš„é«˜çº§ç”¨æ³•

### ğŸš€ æœ€ä½³å®è·µå»ºè®®

```c
// âœ… æ¨è: å¤ç”¨ç¼“å†²åŒº
Mbuffer buff;
luaZ_initbuffer(L, &buff);
for (int i = 0; i < 1000; i++) {
    luaZ_resetbuffer(&buff);  // é‡ç½®è€Œä¸é‡Šæ”¾
    // ä½¿ç”¨ç¼“å†²åŒº...
}
luaZ_freebuffer(L, &buff);

// âŒ ä¸æ¨è: é¢‘ç¹åˆ†é…é‡Šæ”¾
for (int i = 0; i < 1000; i++) {
    Mbuffer buff;
    luaZ_initbuffer(L, &buff);
    // ä½¿ç”¨ç¼“å†²åŒº...
    luaZ_freebuffer(L, &buff);  // æ¯æ¬¡éƒ½é‡æ–°åˆ†é…
}
```

### ğŸ“š å»¶ä¼¸é˜…è¯»

- **è¯æ³•åˆ†æ** â†’ æŸ¥çœ‹ `wiki_lexer.md` äº†è§£ZIOåœ¨è¯æ³•åˆ†æä¸­çš„åº”ç”¨
- **è¯­æ³•åˆ†æ** â†’ æŸ¥çœ‹ `wiki_parser.md` äº†è§£ZIOåœ¨è§£æä¸­çš„ä½¿ç”¨
- **å†…å­˜ç®¡ç†** â†’ æŸ¥çœ‹ `wiki_memory.md` äº†è§£Luaçš„å†…å­˜ç®¡ç†æœºåˆ¶
- **è™šæ‹ŸæœºçŠ¶æ€** â†’ æŸ¥çœ‹ `wiki_vm_state.md` äº†è§£lua_Stateç»“æ„

---

**âœ¨ è¿™ä¸ªè¾“å…¥æµç³»ç»Ÿçš„è®¾è®¡ä½“ç°äº†è‰¯å¥½çš„è½¯ä»¶å·¥ç¨‹åŸåˆ™ï¼ŒåŒ…æ‹¬æŠ½è±¡ã€å°è£…ã€æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†ï¼Œæ˜¯å­¦ä¹ ç³»ç»Ÿçº§Cè¯­è¨€ç¼–ç¨‹çš„ä¼˜ç§€èŒƒä¾‹ã€‚**