# 🔧 编译器模块总览

> **模块定位**：Lua 源码到字节码的转换引擎

## 📋 模块概述

编译器模块负责将 Lua 源代码转换为虚拟机可执行的字节码。它包括词法分析、语法分析和代码生成三个阶段，并在编译期进行多种优化。

### 核心文件

- `lcode.c/h` - 代码生成器
- `llex.c/h` - 词法分析器
- `lopcodes.c/h` - 指令定义
- `ldump.c` - 字节码序列化

## 🎯 核心技术

### 1. 词法分析（Lexical Analysis）

**功能**：将源代码文本转换为 Token 流

**关键技术**：
- 有限状态自动机（FSA）
- 字符分类和识别
- 数字字面量解析
- 字符串转义处理
- 保留字识别

**Token 类型**：
- 关键字（if、while、function 等）
- 标识符（变量名、函数名）
- 字面量（数字、字符串）
- 运算符和分隔符

### 2. 语法分析（Parsing）

**功能**：构建抽象语法树（AST），进行语法检查

**关键技术**：
- 递归下降分析法
- 运算符优先级处理
- 表达式求值
- 作用域管理
- 语法错误恢复

**解析的语法结构**：
- 语句（赋值、控制流、函数定义）
- 表达式（算术、逻辑、表构造）
- 变量声明和作用域

### 3. 代码生成（Code Generation）

**功能**：将 AST 转换为字节码指令

**关键技术**：
- 寄存器分配算法
- 指令选择和优化
- 跳转指令管理
- 常量池管理
- Upvalue 捕获

**生成的产物**：
- Proto 结构（函数原型）
- 字节码指令序列
- 常量表
- Upvalue 列表
- 调试信息

### 4. 编译期优化

**常量折叠**：
```lua
local a = 10 + 20  -- 编译期计算为 30
```

**跳转优化**：
- 消除无用跳转
- 合并跳转链
- 短路求值优化

**寄存器优化**：
- 寄存器复用
- 减少寄存器使用
- 死代码消除

### 5. 字节码格式

**指令编码**：32 位固定长度指令

```
┌───────┬───────┬───────┬───────┐
│  OP   │   A   │   B   │   C   │  iABC 格式
│ 6bit  │ 8bit  │ 9bit  │ 9bit  │
└───────┴───────┴───────┴───────┘

┌───────┬───────┬───────────────┐
│  OP   │   A   │      Bx       │  iABx 格式
│ 6bit  │ 8bit  │    18bit      │
└───────┴───────┴───────────────┘

┌───────┬───────┬───────────────┐
│  OP   │   A   │     sBx       │  iAsBx 格式
│ 6bit  │ 8bit  │  18bit(有符号) │
└───────┴───────┴───────────────┘
```

## 🔧 关键数据结构

### FuncState（函数编译状态）

保存函数编译过程中的所有信息：
- Proto 函数原型
- 寄存器使用情况
- 跳转列表
- 局部变量信息
- Upvalue 信息

### expdesc（表达式描述符）

描述表达式的类型和值：
- 表达式类型（局部变量、全局变量、常量等）
- 寄存器位置或常量索引
- 跳转链表（用于逻辑表达式）

### Proto（函数原型）

存储编译后的函数信息：
- 字节码数组
- 常量数组
- 子函数原型数组
- Upvalue 信息
- 调试信息

## 📚 详细技术文档

- [词法分析器实现](lexer_implementation.md) - Token 生成的详细过程
- [语法分析器实现](parser_implementation.md) - AST 构建和语法检查
- [代码生成算法](codegen_algorithm.md) - 字节码生成的核心算法
- [寄存器分配策略](register_allocation.md) - 寄存器管理和优化
- [常量折叠优化](constant_folding.md) - 编译期常量计算
- [跳转指令优化](jump_optimization.md) - 跳转指令的优化技术

## 🔗 相关模块

- [解析器模块](../parser/wiki_parser.md) - 语法分析的详细实现
- [虚拟机模块](../vm/wiki_vm.md) - 执行编译生成的字节码
- [对象系统模块](../object/wiki_object.md) - 编译器使用的数据类型

---

*继续阅读：[词法分析器实现](lexer_implementation.md)*
